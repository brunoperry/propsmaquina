<!doctype html>
<html lang="en">
<head>
    <title>xxP.Mxx</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=660,user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="shortcut icon" href="favicon.png" type="image/png">

    <style>
    h3,span{color:#A6A2A2;text-align:center;display:block;width:100%}body,button,h3,html,span{display:block}#canvas-container,#menu{position:absolute;height:100%}#quality-buttons,#volume-button,button{position:relative;margin:10px 0}body,html{position:relative;width:100%;height:100%;margin:0;padding:0;background:#000;image-rendering:pixelated;font-family:Arial,Helvetica,sans-serif;-webkit-font-smoothing:none}body{display:flex;justify-content:center;align-items:center;opacity:0;transition:opacity 1.5s}#canvas-container{display:flex;justify-content:center;align-items:center;width:100%}h1{color:#ddd}h2{color:#ddd;font-weight:100;font-size:20px;text-transform:uppercase}h3{position:relative}span{position:relative;font-size:12px;margin-bottom:10px}button{padding:20px;font-size:20px;border:none;background:#ddd;color:#121212;cursor:pointer}button:focus{outline:0}button:hover{opacity:.6}input[type=range]{width:100%;height:100%;cursor:pointer;padding:0;margin:0;opacity:0;touch-action:manipulation}.active,button:active{background:#4F4F4F;color:#ddd}#menu{display:flex;flex-direction:column;align-content:center;justify-content:center;z-index:9999;background:#121212;padding:0 20px}.menu-container{position:relative;display:flex;flex-direction:column;justify-content:center;flex:1}#loader,#overlay,#volume-background{position:absolute}#loader{display:none;flex:1;width:90%}#background{position:relative;display:block;width:0;height:64px;background-color:#fff}#overlay{display:flex;width:100%;height:100%;justify-content:center;background-color:rgba(0,0,0,.8)}#volume-button{flex:1;overflow:hidden;max-height:64px}#volume-button label{position:absolute;line-height:64px;top:0;left:10px;font-size:12px;font-weight:700;pointer-events:none;text-align:left;color:#ddd}#volume-background{display:block;width:100%;height:100%;top:0;pointer-events:none;background-color:#4F4F4F}#quality-buttons{display:flex;justify-content:space-between}.radio-button,.radio-button-active{position:relative;display:block;width:64px;height:64px;font-size:16px;text-align:center;padding:0;color:#ddd}#quality-buttons button{padding:0;margin:0}.radio-button{border-radius:50%;background:0 0;border:5px solid #4F4F4F}.radio-button-active{border-radius:50%;background:#4F4F4F}.shit{transform:scale(3,3)}.fair{transform:scale(2,2)}.cool{transform:scale(1,1)}
    
    </style> 


</head>
<body>
    <div id="canvas-container">
    </div>
    
    <div id="loader">
        <div id="background"></div>
        <h2>LOADING: </h2>
    </div>
    <div id="overlay">
        <div id="menu">
            <h1>xxPROPSxMÁQUINAxx</h1>
            
            <div id="main-menu" class="menu-container">
                <button id="start" onclick="ui.onStart()">PLAY</button>
                <button id="play" onclick="ui.onPlay()">CONTINUE</button>
                <button id="restart" onclick="ui.onRestart()">RESTART</button>
                <button id="replay" onclick="ui.onReplay()">REPLAY</button>
                <button id="fullscreen" onclick="ui.onFullscreen(this)">FULLSCREEN</button>
                <div id="volume-button">
                    <input id="volume-input" type="range" oninput="ui.onVolumeChange(this.value);" onchange="ui.onVolumeChange(this.value);">
                    <div id="volume-background"></div>
                    <label>GAIN: 100</label>
                </div>
                <div id="quality-buttons">
                    <button id="shit" class="radio-button" onclick="ui.onQualityChange(0)">SHIT</button>
                    <button id="fair" class="radio-button-active" onclick="ui.onQualityChange(1)">FAIR</button>
                    <button id="cool" class="radio-button" onclick="ui.onQualityChange(2)">GR8</button>
                </div>
            </div>

            <span>cc ~ NSDC ~ EviL ~ 2017<br></span>
        </div>
    </div>
    <script type="text/javascript">
        function init(){document.getElementsByTagName("body")[0].style.opacity=1,ui=new UI_prod(onUI),window.onresize=ui.setupLayout,console.log("initializing..."),loader=document.getElementById("loader");var t=ui.getQuality();display=new Display({view:document.getElementById("canvas-container"),w:t.w,h:t.h,className:t.className}),target=display.frameBuffer}function startWild(){ui.setLayout(UI_prod.Layouts.START),resources=new Resources(resourcesData,function(t){var e=0;switch(t){case Resources.state.FONT:e=20,t+="...";break;case Resources.state.LOADING_TEXTURES:e=25,t+="...";break;case Resources.state.LOADING_AUDIO:e=100/3,t+="...";break;case Resources.state.LOADING_MESHES:e=50,t+="...";break;case Resources.state.LOADING_COMPLETE:e=100,t+=".",setTimeout(runWild,500)}ui.updateLoader(t,e)}),console.log(resources.getTag())}function runWild(){console.log("*ready*"),(timeline=new Timeline({keyframes:resources.getKeyframes(),callback:onKeyframe})).gotoKeyframe(0),camera=new PropsCamera(target,resources.getAudios()),maquina=new Maquina(resources,target,onMaquina),propsTyper=new PropsTyper(resources,display.getCanvas()),100!==globalVolume&&maquina.setVolume(globalVolume),isRunning=!0,isStarted=!0,ui.setLayout(UI_prod.Layouts.RUNNING),animLoop=window.requestAnimationFrame(loop),maquina.play(timeline.tick),timeline.play()}function endWild(){setTimeout(function(){propsTyper.end(),maquina.pause(),timeline.pause(),ui.setLayout(UI_prod.Layouts.END),window.cancelAnimationFrame(animLoop),animLoop=null,isRunning=!1,console.log("Wild Ended!")},1e3)}function loop(){if(isRunning){target.clear(0),target.clearDepthBuffer(),timeline.update(),camera.update(timeline.tick);var t=camera.getViewProjection();maquina.update(timeline.tick,t),display.swapBuffers(),propsTyper.update(),animLoop=window.requestAnimationFrame(loop)}}function onKeyframe(t){t===Resources.FX.FX12&&endWild(),camera.setCurrentFX(t),maquina.setCurrentFX(t),propsTyper.setCurrentFX(t)}function onUI(t,e){switch(t){case States.START:startWild();break;case States.PLAY:maquina.play(timeline.tick),timeline.play(),animLoop=window.requestAnimationFrame(loop),isRunning=!0,ui.setLayout(UI_prod.Layouts.RUNNING);break;case States.PAUSE:timeline.pause(),maquina.pause(),window.cancelAnimationFrame(animLoop),animLoop=null,isRunning=!1,ui.setLayout(UI_prod.Layouts.MAIN_MENU);break;case States.CHANGE_VOLUME:globalVolume=e,maquina&&maquina.setVolume(globalVolume);break;case States.CHANGE_QUALITY:display.reset(e),target=display.frameBuffer,camera&&camera.resetTarget(target),maquina&&maquina.resetTarget(target),propsTyper&&propsTyper.resetCanvas(display.getCanvas())}}function onMaquina(t,e=null){t<0?propsTyper.updateHeader(e.blink):propsTyper.updateProp(t)}class Utils{static toRadians(t){return t/180*Math.PI}static getInt64Bytes(t){var e=[],s=8;do{e[--s]=255&t,t>>=8}while(s);return e}static genRandomBitmap(t,e){for(var s=new Bitmap({w:t,h:e}),i=0;i<s.getHeight();i++)for(var r=0;r<s.getWidth();r++)s.drawPixel(r,i,parseInt(255*Math.random()+.5),parseInt(255*Math.random()+.5),parseInt(255*Math.random()+.5),parseInt(255*Math.random()+.5));return s}static getImageDataFromImage(t){var e=document.createElement("canvas"),s=e.getContext("2d");return e.width=t.width,e.height=t.height,s.clearRect(0,0,e.width,e.height),s.drawImage(t,0,0),s.getImageData(0,0,e.width,e.height).data}static getAudioDataFromAudio(t,e,s){t.decodeAudioData(e,function(e){if(e){var i=t.createBufferSource();i.buffer=e,i.connect(t.destination),s(i)}},function(t){console.error("error loading buffer: ",t)})}static clamp01(t){return Math.max(1,Math.min(0,t))}static loadFile(t,e,s,i=""){var r;(r=new XMLHttpRequest).responseType=i,r.open("GET",e),r.onreadystatechange=function(){4===r.readyState&&200===r.status&&s(r.response,t)},r.send()}static lerp(t,e,s){return s>=1?e:t+s*(e-t)}static invertImage(t){for(var e=t.data,s=0;s<e.length;s+=4)e[s]=255-e[s],e[s+1]=255-e[s+1],e[s+2]=255-e[s+2];return new ImageData(e,t.width,t.height)}static toFloat32(t){var e=0;switch(t){case Number.POSITIVE_INFINITY:e=2139095040;break;case Number.NEGATIVE_INFINITY:e=4286578688;break;case 0:e=1073741824;break;case-0:e=3221225472;break;default:if(Number.isNaN(t)){e=2143289344;break}t<=-0&&(e=2147483648,t=-t);var s=Math.floor(Math.log(t)/Math.log(2)),i=t/Math.pow(2,s)*8388608|0;(s+=127)>=255?(s=255,i=0):s<0&&(s=0),e|=s<<23,e|=8388607&i}return e}}class BezierCurve{constructor(){this.reset(),this.samples=.2}updateControls(t){this.C0.setPosition(t.C0),this.C1.setPosition(t.C1),this.C2.setPosition(t.C2),this.C3.setPosition(t.C3)}getPoint(t){var e=1-t,s=new Vec4;return s.x=e*e*e*this.C0.get(0)+3*e*e*t*this.C1.get(0)+3*e*t*t*this.C2.get(0)+t*t*t*this.C3.get(0),s.y=e*e*e*this.C0.get(1)+3*e*e*t*this.C1.get(1)+3*e*t*t*this.C2.get(1)+t*t*t*this.C3.get(1),s.z=e*e*e*this.C0.get(2)+3*e*e*t*this.C1.get(2)+3*e*t*t*this.C2.get(2)+t*t*t*this.C3.get(2),s.w=1,s}getDirection(t){var e=1-t,s=new Vec4;return s.x=3*e*e*(this.C1.get(0)-this.C0.get(0))+6*e*t*(this.C2.get(0)-this.C1.get(0))+3*t*t*(this.C3.get(0)-this.C2.get(0)),s.y=3*e*e*(this.C1.get(1)-this.C0.get(1))+6*e*t*(this.C2.get(1)-this.C1.get(1))+3*t*t*(this.C3.get(1)-this.C2.get(1)),s.z=3*e*e*(this.C1.get(2)-this.C0.get(2))+6*e*t*(this.C2.get(2)-this.C1.get(2))+3*t*t*(this.C3.get(2)-this.C2.get(2)),s.w=0,s.normalized().multiply(.1).addVec(this.getPoint(t))}reset(t,e,s,i){this.C0=new Vertex(new Vec4(-1,0,0),new Vec4(1,1,1),new Vec4(1,1,1)),this.C1=new Vertex(new Vec4(-.5,0,0),new Vec4(1,1,1),new Vec4(1,1,1)),this.C2=new Vertex(new Vec4(.5,0,0),new Vec4(1,1,1),new Vec4(1,1,1)),this.C3=new Vertex(new Vec4(1,0,0),new Vec4(1,1,1),new Vec4(1,1,1))}draw(t,e,s=!1){for(var i,r,n,a=[],h=[],o=0;o<=1;o+=this.samples)i=this.getPoint(o),r=e.transform(i),a.push(new Vertex(r,null,null)),s&&(n=e.transform(this.getDirection(o)),h.push({a:new Vertex(r,null,null),b:new Vertex(n,null,null)}));t.drawCurve(a),s&&t.drawTangents(h,Color.red)}}class AudioSource{constructor(t,e,s){this.id=t,this.buffer=s,this.audioContext=e,this.analyser=this.audioContext.createAnalyser(),this.analyser.smoothingTimeConstant=.9,this.gainNode=null,this.sourceNode=null,this.startedAt=0,this.pausedAt=0,this.playing=!1}setGainNode(t){this.gainNode=t}getFrequency(t){var e=new Uint8Array(this.analyser.frequencyBinCount);return this.analyser.getByteFrequencyData(e),e[t]/255}play(){if(!this.playing){var t=this.pausedAt;this.sourceNode=this.audioContext.createBufferSource(),this.sourceNode.buffer=this.buffer,this.sourceNode.connect(this.gainNode),this.sourceNode.connect(this.analyser),this.sourceNode.start(0,t),this.startedAt=Math.abs(this.audioContext.currentTime-t),this.pausedAt=0,this.playing=!0}}pause(){var t=this.audioContext.currentTime-this.startedAt;this.stop(),this.pausedAt=t}stop(){this.playing&&(this.playing&&(this.sourceNode.disconnect(),this.sourceNode.stop(0),this.sourceNode=null),this.pausedAt=0,this.startedAt=0,this.playing=!1)}setTimeAt(t){this.playing?(this.pause(),this.pausedAt=t,this.play()):this.pausedAt=t}playAt(t){this.pause(),this.pausedAt=t/1e3}}var resourcesData={atlas:{name:"atlas",url:"textures/map.png",w:1024,h:1024},textures:[{id:0,mode:0,name:"gear",x:192,y:192,w:64,h:64},{id:1,mode:0,name:"cube",x:512,y:0,w:512,h:512,spritesH:4,spritesV:1},{id:2,mode:0,name:"tunnel",x:256,y:256,w:256,h:256},{id:3,mode:1,name:"flame",x:0,y:192,w:128,h:64,spritesH:2,spritesV:1},{id:4,mode:0,name:"pulsar",x:0,y:512,w:1024,h:512},{id:5,mode:0,name:"pump",x:128,y:192,w:64,h:64}],audios:[{id:0,name:"",url:"audios/clip1.mp3"},{id:1,name:"",url:"audios/clip2.mp3"},{id:2,name:"",url:"audios/clip3.mp3"},{id:3,name:"",url:"audios/clip4.mp3"},{id:4,name:"",url:"audios/clip5.mp3"},{id:5,name:"",url:"audios/clip6.mp3"},{id:6,name:"",url:"audios/clip7.mp3"},{id:7,name:"",url:"audios/clip8.mp3"},{id:8,name:"",url:"audios/clip9.mp3"},{id:9,name:"",url:"audios/clip10.mp3"},{id:10,name:"",url:"audios/clip11.mp3"},{id:11,name:"",url:"audios/clip12.mp3"},{id:12,name:"",url:"audios/clip13.mp3"},{id:13,name:"",url:"audios/clip14.mp3"},{id:14,name:"",url:"audios/clip15.mp3"},{id:15,name:"",url:"audios/clip16.mp3"}],meshes:[{id:0,type:"obj",name:"gear",url:"meshes/gear.obj"},{id:1,type:"obj",name:"cube",url:"meshes/cube.obj"},{id:2,type:"obj",name:"triangle",url:"meshes/triangle.obj"},{id:3,type:"obj",name:"tunnel",url:"meshes/tunnel.obj"},{id:4,type:"obj",name:"plane",url:"meshes/plane.obj"},{id:5,type:"obj",name:"flare",url:"meshes/flare.obj"},{id:6,type:"obj",name:"pump",url:"meshes/pump.obj"},{id:7,type:"obj",name:"pulsar",url:"meshes/pulsar.obj"},{id:8,type:"obj",name:"cube",url:"meshes/cube.obj"},{id:9,type:"obj",name:"flame",url:"meshes/flame.obj"}],keyframes:[0,13500,27074,49889,54088,60770,67701,71380,87888,101403,114493,114930,115e3],props:["CC ~ EviL [N.S.D.C]","WILD INTERVENTION","@INÉRCIA DEMOPARTY 2017","3D SOFTWARE RENDERER JS","**PROPS*MÁQUINA**","EviL","breakneck [RIP]","ps","jeenio","zeroshift","v__pixelnerve","xernobyl","jae686","kazuya","gr9yfox","iq","Navis","T.D.A","napalmcore","A.S.D","SCENEPT"],props2:"PROPS2:",font:[{id:0,name:"A",x:0,y:18,w:18,h:18},{id:1,name:"B",x:18,y:18,w:18,h:18},{id:2,name:"C",x:36,y:18,w:18,h:18},{id:3,name:"D",x:54,y:18,w:18,h:18},{id:4,name:"E",x:72,y:18,w:18,h:18},{id:5,name:"F",x:90,y:18,w:18,h:18},{id:6,name:"G",x:108,y:18,w:18,h:18},{id:7,name:"H",x:126,y:18,w:18,h:18},{id:8,name:"I",x:144,y:18,w:18,h:18},{id:9,name:"J",x:162,y:18,w:18,h:18},{id:10,name:"K",x:180,y:18,w:18,h:18},{id:11,name:"L",x:198,y:18,w:18,h:18},{id:12,name:"M",x:216,y:18,w:18,h:18},{id:13,name:"N",x:234,y:18,w:18,h:18},{id:14,name:"O",x:252,y:18,w:18,h:18},{id:15,name:"P",x:270,y:18,w:18,h:18},{id:16,name:"Q",x:288,y:18,w:18,h:18},{id:17,name:"R",x:306,y:18,w:18,h:18},{id:18,name:"S",x:324,y:18,w:18,h:18},{id:19,name:"T",x:342,y:18,w:18,h:18},{id:20,name:"U",x:360,y:18,w:18,h:18},{id:21,name:"V",x:378,y:18,w:18,h:18},{id:22,name:"W",x:396,y:18,w:18,h:18},{id:23,name:"X",x:414,y:18,w:18,h:18},{id:24,name:"Y",x:432,y:18,w:18,h:18},{id:25,name:"Z",x:450,y:18,w:18,h:18},{id:26,name:"0",x:0,y:72,w:18,h:18},{id:27,name:"1",x:18,y:72,w:18,h:18},{id:28,name:"2",x:36,y:72,w:18,h:18},{id:29,name:"3",x:54,y:72,w:18,h:18},{id:30,name:"4",x:72,y:72,w:18,h:18},{id:31,name:"5",x:90,y:72,w:18,h:18},{id:32,name:"6",x:108,y:72,w:18,h:18},{id:33,name:"7",x:126,y:72,w:18,h:18},{id:34,name:"8",x:144,y:72,w:18,h:18},{id:35,name:"9",x:162,y:72,w:18,h:18},{id:36,name:" ",x:72,y:90,w:18,h:18},{id:37,name:"a",x:0,y:36,w:18,h:18},{id:38,name:"b",x:18,y:36,w:18,h:18},{id:39,name:"c",x:36,y:36,w:18,h:18},{id:40,name:"d",x:54,y:36,w:18,h:18},{id:41,name:"e",x:72,y:36,w:18,h:18},{id:42,name:"f",x:90,y:36,w:18,h:18},{id:43,name:"g",x:108,y:36,w:18,h:18},{id:44,name:"h",x:126,y:36,w:18,h:18},{id:45,name:"i",x:144,y:36,w:18,h:18},{id:46,name:"j",x:162,y:36,w:18,h:18},{id:47,name:"k",x:180,y:36,w:18,h:18},{id:48,name:"l",x:198,y:36,w:18,h:18},{id:49,name:"m",x:216,y:36,w:18,h:18},{id:50,name:"n",x:234,y:36,w:18,h:18},{id:51,name:"o",x:252,y:36,w:18,h:18},{id:52,name:"p",x:270,y:36,w:18,h:18},{id:53,name:"q",x:288,y:36,w:18,h:18},{id:54,name:"r",x:306,y:36,w:18,h:18},{id:55,name:"s",x:324,y:36,w:18,h:18},{id:56,name:"t",x:342,y:36,w:18,h:18},{id:57,name:"u",x:360,y:36,w:18,h:18},{id:58,name:"v",x:378,y:36,w:18,h:18},{id:59,name:"w",x:396,y:36,w:18,h:18},{id:60,name:"x",x:414,y:36,w:18,h:18},{id:61,name:"y",x:432,y:36,w:18,h:18},{id:62,name:"z",x:450,y:36,w:18,h:18},{id:63,name:"~",x:90,y:90,w:18,h:18},{id:64,name:"[",x:36,y:90,w:18,h:18},{id:65,name:"]",x:54,y:90,w:18,h:18},{id:66,name:"Á",x:0,y:0,w:18,h:18},{id:67,name:"É",x:72,y:0,w:18,h:18},{id:68,name:":",x:18,y:90,w:18,h:18},{id:69,name:"*",x:126,y:90,w:18,h:18},{id:70,name:"_",x:108,y:90,w:18,h:18}],tagASCII:"props máquina██████████████████████████████████████████████████████████████2017\n███████████████████████████████████████████████████████████████████████████████\n███████████████████████████████████████████████████████████████████████████████\n███████████████████████████████████████████████████████████████████████████████\n█████████░░░▒████░░░▓███░░░░░░░░░░░░████░░░░░░░░░░░░████▒░░░░░░░░░▓▓███████████\n█████████░░░░░███░░░░███░░░▓████▒░░░████▒░░░███░░░░░▒███░░░░░░░░░░░░███████████\n████████▓░░░░░░▒█░░░░███░░░▒████████████▒░░░█████░░░░███░░░▓█████░░░███████████\n████████░░░░░░░░░░░░░███░░░░░░░░░░░░████▓░░░▒████░░░░███░░░▒███████████████████\n████████░░░░█▓░░░░░░░██████▓████░░░░████▓░░░░▒███░░░░███░░░░████▓░░░░██████████\n████████░░░░███░░░░░░█▒█░░░░█▓▒░░░░░████░░░░░░░░░░░░░███░░░░░░░░░░░░░██████████\n████████░░░▓████░░░░░▒▒█░░░░░░░░░░░█▒▒▒██░░░░░░░░░░░█▓▒▒░░░░░░░░░░░░░██████████\n███████████████████████████████████████████████████████████████████████████████\n███████████████████████████████████████████████████████████████████████████████\n███████████████████████████████████████████████████████████████████████████████\n███████████████████████████████████████████████████████████████████████cc~EviL█"};class Resources{constructor(t,e,s){this.root="resources/",this.callback=e,this.context=s,this.atlasMap=null,this.textures=[],this.texturesLoaded=!1,this.audios=[],this.audiosLoaded=!1,this.audioContext=new AudioContext,this.font=[],this.fontLoaded=!1,this.meshes=[],this.meshesLoaded=!1,this.tagAscii=t.tagASCII;var i=this;this.keyframes=t.keyframes,this.createTextures(t.atlas,t.textures,function(){i.createFont(t.font,function(){i.createAudios(t.audios,function(){i.createMeshes(t.meshes)})})}),this.props=t.props,this.props2=t.props2}createTextures(t,e,s){var i=this,r=new Image;r.onload=function(){i.atlasMap=this;var r=document.createElement("canvas");r.width=t.w,r.height=t.h;var n=r.getContext("2d");n.drawImage(this,0,0);for(var a,h,o,c,u,l,g,p,m=0;m<e.length;m++){if(h=[],(a=e[m]).spritesH)for(var d=a.w/a.spritesH,w=a.h/a.spritesV,y=a.spritesH*a.spritesV,v=0,x=0,f=0;f<y;f++)u=a.x+d*x,l=a.y+w*v,g=d,p=w,o=n.getImageData(u,l,g,p),(c=new Uint8ClampedArray(o.data.length)).set(o.data),h.push(new Bitmap({w:g,h:p,imgData:c,rad:1,name:a.name,mode:parseInt(a.mode)})),++x>=a.spritesH&&(x=0,v++);else u=a.x,l=a.y,g=a.w,p=a.h,o=n.getImageData(u,l,g,p),(c=new Uint8ClampedArray(o.data.length)).set(o.data),h.push(new Bitmap({w:g,h:p,imgData:c,rad:1,name:a.name,mode:parseInt(a.mode)}));i.textures.push(new Texture({id:a.id,bmps:h,type:a.type}))}i.texturesLoaded=!0,i.checkLoadingComplete(),s()},r.src=this.root+t.url}createFont(t,e){var s=document.createElement("canvas");s.width=this.atlasMap.width,s.height=this.atlasMap.height;var i=s.getContext("2d");i.drawImage(this.atlasMap,0,0);for(var r,n,a,h,o,c,u,l,g=0;g<t.length;g++){if(n=[],(r=t[g]).spritesH)for(var p=r.w/r.spritesH,m=r.h/r.spritesV,d=r.spritesH*r.spritesV,w=0,y=0,v=0;v<d;v++)o=r.x+p*y,c=r.y+m*w,u=p,l=m,a=i.getImageData(o,c,u,l),(h=new Uint8ClampedArray(a.data.length)).set(a.data),n.push(new Bitmap({w:u,h:l,imgData:h,rad:1,name:r.name,mode:parseInt(r.mode)})),++y>=r.spritesH&&(y=0,w++);else o=r.x,c=r.y,u=r.w,l=r.h,a=i.getImageData(o,c,u,l),(h=new Uint8ClampedArray(a.data.length)).set(a.data),n.push(new Bitmap({w:u,h:l,imgData:h,rad:1,name:r.name,mode:parseInt(r.mode)}));this.font.push(new Texture({id:r.id,bmps:n}))}this.fontLoaded=!0,this.checkLoadingComplete(),e()}createAudios(t,e){this.callback(Resources.state.LOADING_AUDIO);for(var s=t.length,i=0,r=this,n=0;n<t.length;n++)Utils.loadFile(t[n].id,this.root+t[n].url,function(t,n){var n=n;r.audioContext.decodeAudioData(t,function(t){r.audios.push(new AudioSource(n,r.audioContext,t)),++i===s&&(r.audios.sort(function(t,e){return t.id-e.id}),r.audiosLoaded=!0,r.checkLoadingComplete(),e())})},"arraybuffer")}createMeshes(t){this.callback(Resources.state.LOADING_MESHES);for(var e=t.length,s=0,i=this,r=0;r<t.length;r++){var n=function(t){var r=new Mesh(t);i.meshes.push(r),++s===e&&(i.meshesLoaded=!0,i.checkLoadingComplete())};switch(t[r].type){case Resources.fileType.FBX:FBXLoader.loadFile(this.root+t[r].url,n);break;case Resources.fileType.OBJ:(new OBJModel).loadFile(t[r].name+r.toString(),t[r].id,this.root+t[r].url,n)}}}checkLoadingComplete(){this.fontLoaded&&this.texturesLoaded&&this.audiosLoaded&&this.meshesLoaded&&this.callback(Resources.state.LOADING_COMPLETE)}getKeyframes(){return this.keyframes}getData(){return{textures:this.textures,audios:this.audios,meshes:this.meshes,keyframes:this.keyframes}}getTexture(t){for(var e=0;e<this.textures.length;e++)if(this.textures[e].id==t)return this.textures[e];return null}getMesh(t){for(var e=0;e<this.meshes.length;e++)if(this.meshes[e].id==t)return this.meshes[e];return null}getAudio(t){for(var e=0;e<this.audios.length;e++)if(this.audios[e].id==t)return this.audios[e];return null}getAudioContext(t){return this.audioContext}getAudios(){return this.audios}getTag(){return this.tagAscii}getProps(){return this.props}getProps2(){return this.props2}getFont(){return this.font}getChar(t){for(var e=0;e<this.font.length;e++)if(this.font[e].bmp.name===t)return this.font[e].bmp;return null}}Resources.FX={FX01:0,FX02:1,FX03:2,FX04:3,FX05:4,FX06:5,FX07:6,FX08:7,FX09:8,FX10:9,FX11:10,FX12:11},Resources.state={LOADING_TEXTURES:"loading textures",LOADING_AUDIO:"loading audio",LOADING_MESHES:"loading meshes",LOADING_FONT:"loading font",LOADING_COMPLETE:"loading complete"},Resources.fileType={FBX:"fbx",OBJ:"obj",JPG:"jpg",PNG:"png",MP3:"mp3",OGG:"ogg"};class Object3D{constructor(t,e=!0){this.mesh=t.mesh,this.texture=t.texture,void 0!==t.rad?this.texture.setRadiance(t.rad):this.texture.radiance=1,this.visible=!0,this.texture.useLight(e),this.reset()}update(t,e,s){this.visible&&this.mesh.draw(t,e,this.transform.getTransformation(),this.texture)}reset(){this.transform=new Transform(new Vec4(0,0,0),new Quaternion,new Vec4(1,1,1))}setMainTexture(t){this.texture.setMainTexture(t)}setPos(t){this.transform=this.transform.setPos(t)}getPos(){return this.transform.getPos()}setRotate(t){this.transform=this.transform.rotate(t)}setScale(t){this.transform=this.transform.setScale(t)}get name(){return this.mesh.name}setRadiance(t){this.texture.bmp.setRadiance(t)}lookAt(t,e){this.transform=this.transform.lookAt(t,e)}}class Pump{constructor(t){this.isShown=!1,this.numTunnels=4,this.depth=12,this.tPositions=[],this.tRotations=[],this.tScales=[],this.tunnels=[];for(var e=0;e<this.numTunnels;e++)this.tunnels.push(new Object3D({mesh:t.getMesh(3).clone(),texture:t.getTexture(2).clone()}));this.pumpPos=null,this.pumpRot=null,this.pumpScale=null,this.pumpOffset=(this.numTunnels-1)*this.depth,this.pump=new Object3D({mesh:t.getMesh(6).clone(),texture:t.getTexture(5).clone()}),this.startTime=null,this.journeyLength=null,this.reset()}update(t,e,s){this.isShown||this.show(s);for(var i,r=0;r<this.numTunnels;r++)(i=this.tunnels[r]).setPos(this.tPositions[r]),i.setRotate(this.tRotations[r]),i.setScale(this.tScales[r]),i.update(t,e);this.pump.setPos(this.pumpPos),this.pump.setRotate(this.pumpRot),this.pump.setScale(this.pumpScale),this.pump.update(t,e)}show(t){this.startTime||(this.startTime=Timeline.time(),this.journeyLength=1);for(var e=(Timeline.time()-this.startTime)/this.journeyLength/3,s=Utils.lerp(0,.5,e),i=0;i<this.numTunnels;i++)this.tunnels[i].setRadiance(s);e>=1&&(this.isShown=!0,this.startTime=null)}rotate(t,e=0){for(var s=0;s<this.numTunnels;s++)this.tRotations[s]=new Quaternion({type:Quaternion.Type.INIT_VEC_ANGLE,vec:Vec4.forward(),angle:Utils.toRadians(t+e*s)})}bass(t){var e,s;s=(e=t.getFrequency(3))>=.85?50*(e-.85):0;this.tunnels.length;for(var i=0;i<this.numTunnels;i++)0,this.tPositions[i].z+=s/2*i*(2*i)}doPumpBass(t){var e;e=t>=.2?50*(t-.2):0,this.pumpPos=new Vec4(0,0,e+this.pumpOffset)}reset(){this.tPositions=[],this.tRotations=[],this.tScales=[];for(var t=0;t<this.numTunnels;t++)this.tunnels[t].reset(),this.tPositions.push(new Vec4(0,0,t*this.depth)),this.tRotations.push(new Quaternion({type:Quaternion.Type.INIT_VEC_ANGLE,vec:Vec4.all(),angle:0})),this.tScales.push(new Vec4(1,1,1));this.pump.reset(),this.pumpPos=new Vec4(0,0,this.pumpOffset),this.pumpRot=new Quaternion({type:Quaternion.Type.INIT_VEC_ANGLE,vec:Vec4.up(),angle:Utils.toRadians(180)}),this.pumpScale=new Vec4(1,1,1)}}class Maquina{constructor(t,e,s){this.showCurve=!1,this.showTunnels=!1,this.showPulsar=!1,this.startTime=Timeline.time(),this.callback=s,this.tracks=t.getAudios(),this.renderer=e,this.transform=new Transform(new Vec4(0,0,0),new Quaternion,new Vec4(1,1,1)),this.startTime=null,this.audioContext=t.getAudioContext(),this.gainNode=this.audioContext.createGain(),this.gainNode.connect(this.audioContext.destination);for(var i=0;i<this.tracks.length;i++)this.tracks[i].setGainNode(this.gainNode);this.timerID=null,this.CP0=null,this.CP1=null,this.CP2=null,this.CP3=null,this.currentPoint=null,this.positions=[],this.currentPosition=0,this.rotations=[],this.scales=[],this.directions=[],this.radiosities=[],this.isBlinking=!1,this.journeyLength=null,this.startPos=null,this.endPos=null,this.startScl=null,this.endScl=null,this.rot=null,this.startRot=null,this.rotEnd=null,this.previousFreq=null,this.cubes=[new Object3D({mesh:t.getMesh(1).clone(),texture:t.getTexture(1).clone(),rad:1}),new Object3D({mesh:t.getMesh(1).clone(),texture:t.getTexture(1).clone(),rad:1}),new Object3D({mesh:t.getMesh(8).clone(),texture:t.getTexture(1).clone(),rad:1}),new Object3D({mesh:t.getMesh(1).clone(),texture:t.getTexture(1).clone(),rad:1}),new Object3D({mesh:t.getMesh(1).clone(),texture:t.getTexture(1).clone(),rad:1})],this.cubes[0].setMainTexture(2),this.cubes[1].setMainTexture(1),this.cubes[3].setMainTexture(1),this.cubes[4].setMainTexture(2),this.flameMesh=new Object3D({mesh:t.getMesh(9).clone(),texture:t.getTexture(3).clone()},!1),this.particles=new ParticlesSystem({numParticles:300,resources:this.resources}),this.gears=[new Object3D({mesh:t.getMesh(0).clone(),texture:t.getTexture(0).clone()}),new Object3D({mesh:t.getMesh(0).clone(),texture:t.getTexture(0).clone()}),new Object3D({mesh:t.getMesh(0).clone(),texture:t.getTexture(0).clone()}),new Object3D({mesh:t.getMesh(0).clone(),texture:t.getTexture(0).clone()}),new Object3D({mesh:t.getMesh(0).clone(),texture:t.getTexture(0).clone()})],this.pump=new Pump(t),this.pulsar=new Object3D({mesh:t.getMesh(4).clone(),texture:t.getTexture(4).clone()},!1),this.currentMeshes=this.cubes,this.curve=new BezierCurve,this.reset(),this.currentFX=this.FX01}update(t,e){this.reset(),this.currentFX(t);for(var s=0;s<this.currentMeshes.length;s++)this.currentMeshes[s].update(this.renderer,e,t);this.particles.isEmission&&(this.particles.reset(),this.particles.update(this.renderer,e,t)),this.showTunnels&&this.pump.update(this.renderer,e),this.showPulsar&&this.pulsar.update(this.renderer,e),this.flameMesh.update(this.renderer,e,t),this.showCurve&&this.curve.draw(this.renderer,e,!0)}resetTarget(t){this.renderer=t}reset(){for(var t=0;t<this.currentMeshes.length;t++)this.currentMeshes[t].reset();this.flameMesh.reset(),this.showTunnels&&this.pump.reset(),this.showPulsar&&this.pulsar.reset(),this.particles.isEmission&&this.particles.reset(),this.CP0=new Vertex(new Vec4(-1,0,0),new Vec4(1,1,1),new Vec4(1,1,1)),this.CP1=new Vertex(new Vec4(-.5,0,0),new Vec4(1,1,1),new Vec4(1,1,1)),this.CP2=new Vertex(new Vec4(.5,0,0),new Vec4(1,1,1),new Vec4(1,1,1)),this.CP3=new Vertex(new Vec4(1,0,0),new Vec4(1,1,1),new Vec4(1,1,1)),this.transform=new Transform(new Vec4(0,0,0),new Quaternion,new Vec4(1,1,1)),this.curve.reset(this.CP0.clone(),this.CP1.clone(),this.CP2.clone(),this.CP3.clone()),this.positions=[],this.rotations=[],this.scales=[],this.directions=[],this.radiosities=[]}transformPoints(){var t=this.transform.getTransformation();this.CP0=this.CP0.transform(t,t),this.CP1=this.CP1.transform(t,t),this.CP2=this.CP2.transform(t,t),this.CP3=this.CP3.transform(t,t)}getTransformedData(){return[{pos:this.positions[0],rot:this.rotations[0],scl:this.scales[0],lA:{dir:this.directions[0],up:Vec4.up()},rad:this.radiosities[0]},{pos:this.positions[1],rot:this.rotations[1],scl:this.scales[1],lA:{dir:this.directions[1],up:Vec4.up()},rad:this.radiosities[1]},{pos:this.positions[2],rot:this.rotations[2],scl:this.scales[2],lA:{dir:this.directions[2],up:Vec4.up()},rad:this.radiosities[2]},{pos:this.positions[3],rot:this.rotations[3],scl:this.scales[3],lA:{dir:this.directions[3],up:Vec4.up()},rad:this.radiosities[3]},{pos:this.positions[4],rot:this.rotations[4],scl:this.scales[4],lA:{dir:this.directions[4],up:Vec4.up()},rad:this.radiosities[4]}]}giveGas(t){t?(this.flameMesh.setPos(t.pos),this.flameMesh.setRotate(t.rot),this.flameMesh.setScale(t.scale),this.flameMesh.lookAt(t.dir,Vec4.up())):this.flameMesh.setScale(new Vec4(0,0,0))}FX01(t){var e=this.tracks[0].getFrequency(370);e>0&&(e*=3),this.curve.C0.pos.x-=1.5*e,this.curve.C3.pos.x+=1.5*e,this.positions=[this.curve.getPoint(0),this.curve.getPoint(.25),this.curve.getPoint(.5),this.curve.getPoint(.75),this.curve.getPoint(1)],this.rotations=[new Quaternion({type:Quaternion.Type.INIT_VEC_ANGLE,vec:Vec4.forward(),angle:-4*t}),new Quaternion({type:Quaternion.Type.INIT_VEC_ANGLE,vec:Vec4.forward(),angle:-2*t}),new Quaternion({type:Quaternion.Type.INIT_VEC_ANGLE,vec:Vec4.forward(),angle:t}),new Quaternion({type:Quaternion.Type.INIT_VEC_ANGLE,vec:Vec4.forward(),angle:2*t}),new Quaternion({type:Quaternion.Type.INIT_VEC_ANGLE,vec:Vec4.forward(),angle:4*t})],this.scales=[new Vec4(.25,.25,.25),new Vec4(.5,.5,.5),new Vec4(1,1,1),new Vec4(.5,.5,.5),new Vec4(.25,.25,.25)],this.directions=[this.curve.getDirection(0),this.curve.getDirection(.25),this.curve.getDirection(.5),this.curve.getDirection(.75),this.curve.getDirection(1)];var s=1;e-.2>.1&&(s=100),this.radiosities=[s,s,1,s,s];var i;i=e<.5?new Vec4(e,e,e):new Vec4(0,0,0),this.giveGas({pos:this.positions[2],rot:new Quaternion({type:Quaternion.Type.INIT_VEC_ANGLE,vec:Vec4.forward(),angle:Utils.toRadians(200*t)}),dir:this.directions[3],scale:i}),this.updateMechanics(this.getTransformedData()),this.checkBlink(this.tracks[0].getFrequency(470),0,.001)}FX02(t){this.transform=this.transform.rotate(new Quaternion({type:Quaternion.Type.INIT_VEC_ANGLE,vec:Vec4.all(),angle:t}));var e=2*this.tracks[0].getFrequency(370);e>.1&&(e*=3),this.curve.C0.pos.x-=e,this.curve.C1.pos.x-=e/2,this.curve.C2.pos.x+=e/2,this.curve.C3.pos.x+=e;var s=this.transform.getTransformation();this.curve.C0=this.curve.C0.transform(s,s),this.curve.C1=this.curve.C1.transform(s,s),this.curve.C2=this.curve.C2.transform(s,s),this.curve.C3=this.curve.C3.transform(s,s),this.positions=[this.curve.getPoint(0),this.curve.getPoint(.25),this.curve.getPoint(.5),this.curve.getPoint(.75),this.curve.getPoint(1)],this.rotations=[new Quaternion({type:Quaternion.Type.INIT_VEC_ANGLE,vec:Vec4.forward(),angle:-6*t}),new Quaternion({type:Quaternion.Type.INIT_VEC_ANGLE,vec:Vec4.forward(),angle:-4*t}),new Quaternion({type:Quaternion.Type.INIT_VEC_ANGLE,vec:Vec4.forward(),angle:-2*t}),new Quaternion({type:Quaternion.Type.INIT_VEC_ANGLE,vec:Vec4.forward(),angle:4*t}),new Quaternion({type:Quaternion.Type.INIT_VEC_ANGLE,vec:Vec4.forward(),angle:6*t})],(r=Math.abs(1.1*Math.sin(t))+e)<1&&(r=1),this.scales=[new Vec4(.25,.25,.25),new Vec4(.5,.5,.5),new Vec4(r,r,1),new Vec4(.5,.5,.5),new Vec4(.25,.25,.25)],this.directions=[this.curve.getDirection(0),this.curve.getDirection(.25),this.curve.getDirection(.5),this.curve.getDirection(.75),this.curve.getDirection(1)];var i=1;this.tracks[3].getFrequency(10)>=.85&&(i=100),this.radiosities=[i,i,100,i,i];var r;(e=this.tracks[0].getFrequency(370))>0&&(e*=3),r=e>.2?new Vec4(1.2*e,1.2*e,1.2*e):new Vec4(0,0,0),this.giveGas({pos:this.positions[2],rot:new Quaternion({type:Quaternion.Type.INIT_VEC_ANGLE,vec:Vec4.forward(),angle:Utils.toRadians(200*t)}),dir:this.directions[3],scale:r}),this.updateMechanics(this.getTransformedData()),this.checkBlink(this.tracks[0].getFrequency(470),0,1e-4)}FX03(t){this.transform=this.transform.rotate(new Quaternion({type:Quaternion.Type.INIT_VEC_ANGLE,vec:Vec4.all(),angle:t}));var e=Math.abs(1.1*Math.sin(t));this.curve.C0.pos.x=-2,this.curve.C1.pos.x-=e,this.curve.C1.pos.y-=e,this.curve.C1.pos.z-=e,this.curve.C2.pos.x-=e/2,this.curve.C2.pos.y+=e/2,this.curve.C2.pos.z+=e,this.curve.C3.pos.x=2;var s=this.transform.getTransformation();this.curve.C0=this.curve.C0.transform(s,s),this.curve.C1=this.curve.C1.transform(s,s),this.curve.C2=this.curve.C2.transform(s,s),this.curve.C3=this.curve.C3.transform(s,s),this.positions=[this.curve.getPoint(0),this.curve.getPoint(.25),this.curve.getPoint(.5),this.curve.getPoint(.75),this.curve.getPoint(1)],this.rot=-8*t,this.rotations=[new Quaternion({type:Quaternion.Type.INIT_VEC_ANGLE,vec:Vec4.forward(),angle:-15*t}),new Quaternion({type:Quaternion.Type.INIT_VEC_ANGLE,vec:Vec4.forward(),angle:-10*t}),new Quaternion({type:Quaternion.Type.INIT_VEC_ANGLE,vec:Vec4.forward(),angle:this.rot}),new Quaternion({type:Quaternion.Type.INIT_VEC_ANGLE,vec:Vec4.forward(),angle:10*t}),new Quaternion({type:Quaternion.Type.INIT_VEC_ANGLE,vec:Vec4.forward(),angle:15*t})];var i=this.tracks[3].getFrequency(10);i<.85?i=1:i*=1.2;var r=Math.sin(.25*t),n=Math.sin(.5*t),a=Math.sin(.75*t),h=Math.sin(1*t);this.scales=[new Vec4(.25*r,.25*r,.25*r),new Vec4(.5*n,.5*n,.5*n),new Vec4(i,i,1),new Vec4(.5*a,.5*a,.5*a),new Vec4(.25*h,.25*h,.25*h)],this.directions=[this.curve.getDirection(0),this.curve.getDirection(.25),this.curve.getDirection(.5),this.curve.getDirection(.75),this.curve.getDirection(1)];var o=1;this.tracks[3].getFrequency(10)>=.85&&(o=100),this.radiosities=[o,o,o,o,o],this.giveGas(),this.updateMechanics(this.getTransformedData()),this.checkBlink(this.tracks[15].getFrequency(358),0,.001)}FX04(t){this.transform=this.transform.rotate(new Quaternion({type:Quaternion.Type.INIT_VEC_ANGLE,vec:Vec4.up(),angle:t}));var e=Math.sin(t);this.curve.C0.pos.x=-.8,this.curve.C0.pos.y=1.2*e,this.curve.C1.pos.x=-.9,this.curve.C1.pos.y=-e,this.curve.C2.pos.x=.9,this.curve.C2.pos.y=e,this.curve.C3.pos.x=.8,this.curve.C3.pos.y=-1.2*e;var s=this.transform.getTransformation();this.curve.C0=this.curve.C0.transform(s,s),this.curve.C1=this.curve.C1.transform(s,s),this.curve.C2=this.curve.C2.transform(s,s),this.curve.C3=this.curve.C3.transform(s,s),this.positions=[this.curve.getPoint(0),this.curve.getPoint(.25),this.curve.getPoint(.5),this.curve.getPoint(.75),this.curve.getPoint(1)],this.rotations=[new Quaternion({type:Quaternion.Type.INIT_VEC_ANGLE,vec:Vec4.forward(),angle:-20*t}),new Quaternion({type:Quaternion.Type.INIT_VEC_ANGLE,vec:Vec4.forward(),angle:-15*t}),new Quaternion({type:Quaternion.Type.INIT_VEC_ANGLE,vec:Vec4.forward(),angle:-8*t}),new Quaternion({type:Quaternion.Type.INIT_VEC_ANGLE,vec:Vec4.forward(),angle:15*t}),new Quaternion({type:Quaternion.Type.INIT_VEC_ANGLE,vec:Vec4.forward(),angle:20*t})],this.scales=[new Vec4(.25,.25,.25),new Vec4(.5,.5,.5),new Vec4(1,1,1),new Vec4(.5,.5,.5),new Vec4(.25,.25,.25)],this.directions=[this.curve.getDirection(0),this.curve.getDirection(.25),this.curve.getDirection(.5),this.curve.getDirection(.75),this.curve.getDirection(1)];var i=1;this.tracks[3].getFrequency(10)>=.85&&(i=100),this.radiosities=[i,i,100,i,i],this.giveGas(),this.updateMechanics(this.getTransformedData()),this.checkBlink(this.tracks[15].getFrequency(358),0,.001)}FX05(t){var e=null,s=this.tracks[5].getFrequency(170);e=1===Maquina.RotationDirection?t+s:-(t+s),this.transform=this.transform.rotate(new Quaternion({type:Quaternion.Type.INIT_VEC_ANGLE,vec:Vec4.up(),angle:e})),this.curve.C0.pos.x=-.8,this.curve.C1.pos.x=-.9,this.curve.C2.pos.x=.9,this.curve.C3.pos.x=.8;var i=this.transform.getTransformation();this.curve.C0=this.curve.C0.transform(i,i),this.curve.C1=this.curve.C1.transform(i,i),this.curve.C2=this.curve.C2.transform(i,i),this.curve.C3=this.curve.C3.transform(i,i),this.positions=[this.curve.getPoint(0),this.curve.getPoint(.25),this.curve.getPoint(.5),this.curve.getPoint(.75),this.curve.getPoint(1)],this.rotations=[new Quaternion({type:Quaternion.Type.INIT_VEC_ANGLE,vec:Vec4.forward(),angle:-(t+1.5*s)}),new Quaternion({type:Quaternion.Type.INIT_VEC_ANGLE,vec:Vec4.forward(),angle:-(t+1.2*s)}),new Quaternion({type:Quaternion.Type.INIT_VEC_ANGLE,vec:Vec4.forward(),angle:s}),new Quaternion({type:Quaternion.Type.INIT_VEC_ANGLE,vec:Vec4.forward(),angle:t+1.2*s}),new Quaternion({type:Quaternion.Type.INIT_VEC_ANGLE,vec:Vec4.forward(),angle:t+1.5*s})],this.scales=[new Vec4(.25,.25,.25),new Vec4(.5,.5,.5),new Vec4(1,1,1),new Vec4(.5,.5,.5),new Vec4(.25,.25,.25)],this.directions=[this.curve.getDirection(0),this.curve.getDirection(.25),this.curve.getDirection(.5),this.curve.getDirection(.75),this.curve.getDirection(1)];this.radiosities=[1,1,1,1,1],this.giveGas(),this.updateMechanics(this.getTransformedData())}FX06(t){var e=Math.sin(t/10),s=this.tracks[5].getFrequency(170);this.curve.C0.pos.x=-.7,this.curve.C0.pos.y=-(e+s),this.curve.C1.pos.x=-.8,this.curve.C2.pos.x=.8,this.curve.C3.pos.x=.7,this.curve.C3.pos.y=e+s;var i=null;i=1===Maquina.RotationDirection?t+s:-(t+s),this.transform=this.transform.rotate(new Quaternion({type:Quaternion.Type.INIT_VEC_ANGLE,vec:Vec4.up(),angle:i}));var r=this.transform.getTransformation();this.curve.C0=this.curve.C0.transform(r,r),this.curve.C1=this.curve.C1.transform(r,r),this.curve.C2=this.curve.C2.transform(r,r),this.curve.C3=this.curve.C3.transform(r,r),this.positions=[this.curve.getPoint(0),this.curve.getPoint(.25),this.curve.getPoint(.5),this.curve.getPoint(.75),this.curve.getPoint(1)],this.rotations=[new Quaternion({type:Quaternion.Type.INIT_VEC_ANGLE,vec:Vec4.forward(),angle:-(t+1.5*s)}),new Quaternion({type:Quaternion.Type.INIT_VEC_ANGLE,vec:Vec4.forward(),angle:-(t+1.2*s)}),new Quaternion({type:Quaternion.Type.INIT_VEC_ANGLE,vec:Vec4.forward(),angle:3*s}),new Quaternion({type:Quaternion.Type.INIT_VEC_ANGLE,vec:Vec4.forward(),angle:t+1.2*s}),new Quaternion({type:Quaternion.Type.INIT_VEC_ANGLE,vec:Vec4.forward(),angle:t+1.5*s})],this.scales=[new Vec4(.25,.25,.25),new Vec4(.5,.5,.5),new Vec4(1,1,1),new Vec4(.5,.5,.5),new Vec4(.25,.25,.25)],this.directions=[this.curve.getDirection(0),this.curve.getDirection(.25),this.curve.getDirection(.5),this.curve.getDirection(.75),this.curve.getDirection(1)];this.radiosities=[1,1,1,1,1],this.giveGas(),this.updateMechanics(this.getTransformedData())}FX07(t){var e,s=(Timeline.time()-this.startTime)/this.journeyLength*180,i=Vec4.lerpVecs(this.startRot,this.endRot,s);e=new Quaternion(s<1?{type:Quaternion.Type.INIT_VEC_ANGLE,vec:Vec4.all(),angle:Utils.toRadians(i.x)}:{type:Quaternion.Type.INIT_VEC_ANGLE,vec:Vec4.all(),angle:Utils.toRadians(this.endRot.x)}),this.transform=this.transform.rotate(e);var r=Vec4.lerpVecs(new Vec4(.7,.7,.7),new Vec4(1,1,1),s).x,n=Vec4.lerpVecs(new Vec4(.8,.8,.8),new Vec4(.5,.5,.5),s).x;s>1&&(r=1,n=.5);var a=Math.sin(t)/2.5;this.curve.C0.pos.x=-r,this.curve.C1.pos.x=-n,this.curve.C1.pos.y=a,this.curve.C2.pos.x=n,this.curve.C2.pos.y=-a,this.curve.C3.pos.x=r;var h=this.transform.getTransformation();this.curve.C0=this.curve.C0.transform(h,h),this.curve.C1=this.curve.C1.transform(h,h),this.curve.C2=this.curve.C2.transform(h,h),this.curve.C3=this.curve.C3.transform(h,h),this.positions=[this.curve.getPoint(0),this.curve.getPoint(.25),this.curve.getPoint(.5),this.curve.getPoint(.75),this.curve.getPoint(1)],this.rotations=[new Quaternion({type:Quaternion.Type.INIT_VEC_ANGLE,vec:Vec4.forward(),angle:-8*t}),new Quaternion({type:Quaternion.Type.INIT_VEC_ANGLE,vec:Vec4.forward(),angle:-5*t}),new Quaternion({type:Quaternion.Type.INIT_VEC_ANGLE,vec:Vec4.forward(),angle:20*t}),new Quaternion({type:Quaternion.Type.INIT_VEC_ANGLE,vec:Vec4.forward(),angle:5*t}),new Quaternion({type:Quaternion.Type.INIT_VEC_ANGLE,vec:Vec4.forward(),angle:8*t})];var o=Vec4.lerpVecs(new Vec4(500,0,0),new Vec4(200,0,0),s);this.rotations[2]=new Quaternion({type:Quaternion.Type.INIT_VEC_ANGLE,vec:Vec4.forward(),angle:Utils.toRadians(t*o.x)}),this.scales=[new Vec4(.25,.25,.25),new Vec4(.5,.5,.5),new Vec4(1,1,1),new Vec4(.5,.5,.5),new Vec4(.25,.25,.25)],this.directions=[this.curve.getDirection(0),this.curve.getDirection(.25),this.curve.getDirection(.5),this.curve.getDirection(.75),this.curve.getDirection(1)];this.radiosities=[1,1,1,1,1],this.pump.rotate(3*t),this.pump.doPumpBass(this.tracks[7].getFrequency(100)),this.giveGas(),this.updateMechanics(this.getTransformedData())}FX08(t){var e=Math.sin(t)/2.5;this.curve.C0.pos.x=-1,this.curve.C1.pos.x=-.5,this.curve.C1.pos.y=e,this.curve.C2.pos.x=.5,this.curve.C2.pos.y=-e,this.curve.C3.pos.x=1,this.positions=[this.curve.getPoint(0),this.curve.getPoint(.25),this.curve.getPoint(.5),this.curve.getPoint(.75),this.curve.getPoint(1)],this.rotations=[new Quaternion({type:Quaternion.Type.INIT_VEC_ANGLE,vec:Vec4.forward(),angle:10*t}),new Quaternion({type:Quaternion.Type.INIT_VEC_ANGLE,vec:Vec4.forward(),angle:5*t}),new Quaternion({type:Quaternion.Type.INIT_VEC_ANGLE,vec:Vec4.forward(),angle:Utils.toRadians(200*t)}),new Quaternion({type:Quaternion.Type.INIT_VEC_ANGLE,vec:Vec4.forward(),angle:-5*t}),new Quaternion({type:Quaternion.Type.INIT_VEC_ANGLE,vec:Vec4.forward(),angle:-10*t})],this.scales=[new Vec4(.25,.25,.25),new Vec4(.5,.5,.5),new Vec4(1,1,1),new Vec4(.5,.5,.5),new Vec4(.25,.25,.25)],this.directions=[this.curve.getDirection(0),this.curve.getDirection(.25),this.curve.getDirection(.5),this.curve.getDirection(.75),this.curve.getDirection(1)],this.radiosities=[1,1,1,1,1];var s=this.tracks[6].getFrequency(3);this.isBlinking!==this.blink()&&(this.isBlinking=!this.isBlinking,this.currentPosition++,this.callback(s),this.currentPosition>=this.positions.length&&(this.currentPosition=0)),this.isBlinking&&(this.scales[this.currentPosition]=new Vec4(1.1,1.3,1.1),this.radiosities[this.currentPosition]=1e3),this.pump.bass(this.tracks[10]),this.pump.doPumpBass(this.tracks[7].getFrequency(100)),this.pump.rotate(3*t),(e=this.tracks[10].getFrequency(3))>.01?(this.callback(-1,{blink:!0}),this.giveGas({pos:this.positions[this.currentPosition],rot:new Quaternion({type:Quaternion.Type.INIT_VEC_ANGLE,vec:Vec4.forward(),angle:Utils.toRadians(200*t)}),dir:this.directions[this.currentPosition],scale:new Vec4(e-.7,e-.7,e-.7)})):(this.callback(-1,{blink:!1}),this.giveGas()),this.updateMechanics(this.getTransformedData())}FX09(t){var e=Math.sin(t)/2.5;this.curve.C0.pos.x=-1,this.curve.C1.pos.x=-.5,this.curve.C1.pos.y=e,this.curve.C2.pos.x=.5,this.curve.C2.pos.y=-e,this.curve.C3.pos.x=1,this.positions=[this.curve.getPoint(0),this.curve.getPoint(.25),this.curve.getPoint(.5),this.curve.getPoint(.75),this.curve.getPoint(1)],this.rotations=[new Quaternion({type:Quaternion.Type.INIT_VEC_ANGLE,vec:Vec4.forward(),angle:10*t}),new Quaternion({type:Quaternion.Type.INIT_VEC_ANGLE,vec:Vec4.forward(),angle:5*t}),new Quaternion({type:Quaternion.Type.INIT_VEC_ANGLE,vec:Vec4.forward(),angle:3*t}),new Quaternion({type:Quaternion.Type.INIT_VEC_ANGLE,vec:Vec4.forward(),angle:-5*t}),new Quaternion({type:Quaternion.Type.INIT_VEC_ANGLE,vec:Vec4.forward(),angle:-10*t})],this.scales=[new Vec4(.25,.25,.25),new Vec4(.5,.5,.5),new Vec4(1,1,1),new Vec4(.5,.5,.5),new Vec4(.25,.25,.25)],this.directions=[this.curve.getDirection(0),this.curve.getDirection(.25),this.curve.getDirection(.5),this.curve.getDirection(.75),this.curve.getDirection(1)],this.radiosities=[1,1,1,1,1];var s=this.tracks[6].getFrequency(3);this.isBlinking!==this.blink()&&(this.isBlinking=!this.isBlinking,this.currentPosition++,this.callback(s),this.currentPosition>=this.positions.length&&(this.currentPosition=0)),this.isBlinking&&(this.scales[this.currentPosition]=new Vec4(1.1,1.3,1.1),this.radiosities[this.currentPosition]=1e3),this.pump.bass(this.tracks[10]),this.pump.doPumpBass(this.tracks[10].getFrequency(3)),this.pump.rotate(3*t),(e=this.tracks[10].getFrequency(3))>.01?(this.callback(-1,{blink:!0}),this.giveGas({pos:this.positions[this.currentPosition],rot:new Quaternion({type:Quaternion.Type.INIT_VEC_ANGLE,vec:Vec4.forward(),angle:Utils.toRadians(200*t)}),dir:this.directions[this.currentPosition],scale:new Vec4(e-.7,e-.7,e-.7)})):(this.callback(-1,{blink:!1}),this.giveGas()),this.updateMechanics(this.getTransformedData())}FX10(t){var e=Math.sin(t)/2.5;this.curve.C0.pos.x=-1,this.curve.C1.pos.x=-.5,this.curve.C1.pos.y=-e,this.curve.C2.pos.x=.5,this.curve.C2.pos.y=e,this.curve.C3.pos.x=1,this.positions=[this.curve.getPoint(0),this.curve.getPoint(.25),this.curve.getPoint(.5),this.curve.getPoint(.75),this.curve.getPoint(1)],this.rotations=[new Quaternion({type:Quaternion.Type.INIT_VEC_ANGLE,vec:Vec4.forward(),angle:10*t}),new Quaternion({type:Quaternion.Type.INIT_VEC_ANGLE,vec:Vec4.forward(),angle:5*t}),new Quaternion({type:Quaternion.Type.INIT_VEC_ANGLE,vec:Vec4.forward(),angle:t}),new Quaternion({type:Quaternion.Type.INIT_VEC_ANGLE,vec:Vec4.forward(),angle:-5*t}),new Quaternion({type:Quaternion.Type.INIT_VEC_ANGLE,vec:Vec4.forward(),angle:-10*t})],this.scales=[new Vec4(.25,.25,.25),new Vec4(.5,.5,.5),new Vec4(1,1,1),new Vec4(.5,.5,.5),new Vec4(.25,.25,.25)],this.directions=[this.curve.getDirection(0),this.curve.getDirection(.25),this.curve.getDirection(.5),this.curve.getDirection(.75),this.curve.getDirection(1)],this.radiosities=[1,1,1,1,1];var s=this.tracks[6].getFrequency(3);this.isBlinking!==this.blink()&&(this.isBlinking=!this.isBlinking,this.currentPosition++,this.callback(s),this.currentPosition>=this.positions.length&&(this.currentPosition=0)),this.isBlinking&&(this.scales[this.currentPosition]=new Vec4(1.1,1.5,1.1),this.radiosities[this.currentPosition]=1e3),this.pump.bass(this.tracks[10]),this.pump.doPumpBass(this.tracks[10].getFrequency(3)),this.pump.rotate(3*t),this.pulsar.setPos(new Vec4(0,0,-80)),this.pulsar.setScale(new Vec4(40,40,40)),(e=this.tracks[10].getFrequency(3))>.01?(this.callback(-1,{blink:!0}),this.giveGas({pos:this.positions[this.currentPosition],rot:new Quaternion({type:Quaternion.Type.INIT_VEC_ANGLE,vec:Vec4.forward(),angle:Utils.toRadians(200*t)}),dir:this.directions[this.currentPosition],scale:new Vec4(e-.5,e-.5,e-.5)})):(this.callback(-1,{blink:!1}),this.giveGas()),this.updateMechanics(this.getTransformedData())}FX11(t){var e=Math.sin(t)/2.5;this.curve.C0.pos.x=-1,this.curve.C1.pos.x=-.5,this.curve.C1.pos.y=-e,this.curve.C2.pos.x=.5,this.curve.C2.pos.y=e,this.curve.C3.pos.x=1,this.positions=[this.curve.getPoint(0),this.curve.getPoint(.25),this.curve.getPoint(.5),this.curve.getPoint(.75),this.curve.getPoint(1)],this.scales=[new Vec4(.25,.25,.25),new Vec4(.5,.5,.5),new Vec4(1,1,1),new Vec4(.5,.5,.5),new Vec4(.25,.25,.25)],this.directions=[this.curve.getDirection(0),this.curve.getDirection(.25),this.curve.getDirection(.5),this.curve.getDirection(.75),this.curve.getDirection(1)],this.rotations=[new Quaternion({type:Quaternion.Type.INIT_VEC_ANGLE,vec:Vec4.forward(),angle:10*t}),new Quaternion({type:Quaternion.Type.INIT_VEC_ANGLE,vec:Vec4.forward(),angle:5*t}),new Quaternion({type:Quaternion.Type.INIT_VEC_ANGLE,vec:Vec4.forward(),angle:t}),new Quaternion({type:Quaternion.Type.INIT_VEC_ANGLE,vec:Vec4.forward(),angle:-5*t}),new Quaternion({type:Quaternion.Type.INIT_VEC_ANGLE,vec:Vec4.forward(),angle:-10*t})],this.radiosities=[1e3,1e3,1e3,1e3,1e3],this.giveGas(),this.updateMechanics(this.getTransformedData())}checkBlink(t,e,s){t>s&&!this.isBlinking?(this.isBlinking=!0,this.callback(t)):t<s&&this.isBlinking&&(this.isBlinking=!1)}blink(){var t=this.tracks[8].getFrequency(698),e=!1;return this.previousFreq&&t-this.previousFreq<0&&(e=!0),this.previousFreq=t,e}updateMechanics(t){for(var e,s=0;s<this.currentMeshes.length;s++)(e=this.currentMeshes[s]).setPos(t[s].pos),e.setRotate(t[s].rot),e.setScale(t[s].scl),void 0!==t[s].lA&&e.lookAt(t[s].lA.dir,t[s].lA.up),e.setRadiance(t[s].rad)}setCurrentFX(t){switch(this.startTime=Timeline.time(),this.showTunnels=!1,this.showPulsar=!1,this.pump.isShown=!1,this.particles.stopEmission(),this.pulsar.texture.stop(),this.cubes[2].setMainTexture(0),this.flameMesh.setMainTexture(1),this.timerID&&t!==Resources.FX.FX06&&(window.clearInterval(this.timerID),this.timerID=null),console.log("FX0"+(t+1)),t){case Resources.FX.FX01:this.cubes[2].setMainTexture(3),this.isBlinking=!1,this.currentMeshes=this.cubes,this.currentFX=this.FX01;break;case Resources.FX.FX02:this.startScl=new Vec4(3,3,3),this.endScl=new Vec4(.75,.75,.75),this.journeyLength=Vec4.distance(this.startScl,this.endScl),this.currentMeshes=this.cubes,this.currentFX=this.FX02;break;case Resources.FX.FX03:this.currentMeshes=this.cubes,this.currentFX=this.FX03;break;case Resources.FX.FX04:this.startScl=this.endScl,this.endScl=new Vec4(.75,.75,.75),this.startRot=new Vec4(8,8,8),this.endRot=new Vec4(1,1,1),this.journeyLength=Vec4.distance(this.startRot,this.endRot),this.currentMeshes=this.cubes,this.currentFX=this.FX04;break;case Resources.FX.FX05:this.timerID=window.setInterval(function(){1===Maquina.RotationDirection?Maquina.RotationDirection=0:Maquina.RotationDirection=1},3275),this.currentMeshes=this.cubes,this.currentFX=this.FX05;break;case Resources.FX.FX06:this.particles.setSimulation([this.cubes[0].getPos(),this.cubes[1].getPos(),this.cubes[2].getPos(),this.cubes[3].getPos(),this.cubes[4].getPos()]),this.particles.startEmission(),this.currentMeshes=this.gears,this.currentFX=this.FX06;break;case Resources.FX.FX07:this.showTunnels=!0,this.startPos=new Vec4(0,0,0),this.endPos=new Vec4(0,0,24),this.startRot=new Vec4(300,300,300),this.endRot=new Vec4(0,0,0),this.journeyLength=Vec4.distance(this.startRot,this.endRot),this.currentMeshes=this.gears,this.currentFX=this.FX07;break;case Resources.FX.FX08:this.isBlinking=!1,this.showTunnels=!0,this.pump.isShown=!0,this.currentMeshes=this.gears,this.currentFX=this.FX08;break;case Resources.FX.FX09:this.isBlinking=!1,this.showTunnels=!0,this.pump.isShown=!0,this.currentMeshes=this.gears,this.currentFX=this.FX09;break;case Resources.FX.FX10:this.pulsar.texture.play(),this.showTunnels=!0,this.showPulsar=!0,this.pump.isShown=!0,this.currentMeshes=this.gears,this.currentFX=this.FX10;break;case Resources.FX.FX11:this.currentMeshes=this.gears,this.currentFX=this.FX11}}setAudioTime(t){for(var e=0;e<this.tracks.length;e++)this.tracks[e].setTimeAt(t)}setVolume(t){this.gainNode.gain.value=t/100}play(){this.startTime=Timeline.time();for(var t=0;t<this.tracks.length;t++)this.tracks[t].play()}pause(){for(var t=0;t<this.tracks.length;t++)this.tracks[t].pause()}getFrequency(t,e){return this.tracks[t].getFrequency(e)}}Maquina.RotationDirection=1;class Color{constructor(t=255,e=255,s=255,i=255){this.r=t,this.g=e,this.b=s,this.a=i}mul(t){this.r=this.r*t,this.g=this.g*t,this.b=this.b*t}static blendAlpha(t,e,s){return 0===s?e:1===s?t:new Color(s*t.r+(1-s)*e.r,s*t.g+(1-s)*e.g,s*t.b+(1-s)*e.b)}}Color.white={r:255,g:255,b:255,a:255},Color.red={r:255,g:0,b:0,a:255},Color.green={r:0,g:255,b:0,a:255},Color.blue={r:0,g:0,b:255,a:255};class FBXLoader{constructor(){}static vertListToVecList(t){for(var e=[],s=null,i=0;i<t.length/3;i++)s=new Vec4(parseFloat(t[3*i+0]),parseFloat(t[3*i+1]),parseFloat(t[3*i+2],1)),e.push(s);return e}static indicesListToFacesList(t){for(var e,s=[],i=0;i<t.length;i++)(e=parseInt(t[i]))<0?s.push(-1*e-1):s.push(e);return s}static UVListToVecList(t,e){for(var s,i=[],r=[],n=0;n<t.length;n+=2){var a=t[n],h=t[n+1];r[n]=[a,h]}for(var o=[],n=0;n<r.length;n++)void 0!==r[n]&&o.push(r[n]);r=o;for(n=0;n<e.length/2;n++)s=new Vec4(parseFloat(r[parseInt(e[n])]),parseFloat(r[parseInt(e[n+1])]),0,0),i.push(s);return i}static loadFile(t,e){var s=new XMLHttpRequest;s.open("GET",t),s.onreadystatechange=function(){4===s.readyState&&200===s.status&&r(s.responseText)},s.send();var i={},r=function(t){for(var s="",r=t.search(FBXLoader.Tag.VERTICES)+FBXLoader.Tag.VERTICES.length,n=r;n<t.length&&"P"!==t.charAt(n);n++)s+=t.charAt(n);var a=s.replace(/[\n\r]+/g,"").replace(/\s{2,10}/g," ");i.vertices=FBXLoader.vertListToVecList(a.split(","));s="";for(n=r=t.search(FBXLoader.Tag.POLY_VERTEX_INDEX)+FBXLoader.Tag.POLY_VERTEX_INDEX.length;n<t.length&&"E"!==t.charAt(n);n++)s+=t.charAt(n);var h=s.replace(/[\n\r]+/g,"").replace(/\s{2,10}/g," ");i.indices=FBXLoader.indicesListToFacesList(h.split(","));s="";for(n=r=t.search(FBXLoader.Tag.UV)+FBXLoader.Tag.UV.length;n<t.length&&"U"!==t.charAt(n);n++)s+=t.charAt(n);var o=s.replace(/[\n\r]+/g,"").replace(/\s{2,10}/g," ");s="";for(n=r=t.search(FBXLoader.Tag.UV_INDEX)+FBXLoader.Tag.UV_INDEX.length;n<t.length&&"}"!==t.charAt(n);n++)s+=t.charAt(n);var c=s.replace(/[\n\r]+/g,"").replace(/\s{2,10}/g," ");i.uvs=FBXLoader.UVListToVecList(o.split(","),c.split(",")),e(i)}}}FBXLoader.Tag={VERTICES:"Vertices: ",POLY_VERTEX_INDEX:"PolygonVertexIndex: ",UV:"UVs: ",UV_INDEX:"UVIndex: "};class OBJModel{constructor(){return this.positions=[],this.texCoords=[],this.normals=[],this.indices=[],this.hasTexCoords=!1,this.hasNormals=!1,this}loadFile(t,e,s,i){this.id=e,this.name=t,this.callback=i;var r=this,n=new XMLHttpRequest;n.open("GET",s),n.onreadystatechange=function(){4===n.readyState&&200===n.status&&r.parse(n.responseText)},n.send()}parse(t){for(var e,s=t.split("\n"),i=0;i<s.length;i++)if(e=s[i].split(" "),0!==(e=OBJModel.removeEmptyStrings(e)).length&&"#"!==e[0])if("v"===e[0])this.positions.push(new Vec4(parseFloat(e[1]),parseFloat(e[2]),parseFloat(e[3]),1));else if("vt"===e[0])this.texCoords.push(new Vec4(parseFloat(e[1]),1-parseFloat(e[2]),0,0));else if("vn"===e[0])this.normals.push(new Vec4(parseFloat(e[1]),parseFloat(e[2]),parseFloat(e[3]),0));else if("f"===e[0])for(var r=0;r<e.length-3;r++)this.indices.push(this.parseOBJIndex(e[1])),this.indices.push(this.parseOBJIndex(e[2+r])),this.indices.push(this.parseOBJIndex(e[3+r]));this.callback(this.toIndexedModel())}toIndexedModel(){for(var t=new IndexedModel(this.id,this.name),e=new IndexedModel,s=[],i=[],r=[],n=0;n<this.indices.length;n++){var a,h,o=this.indices[n],c=this.positions[o.getVertexIndex()];a=this.hasTexCoords?this.texCoords[o.getTexCoordIndex()]:new Vec4(0,0,0,0),h=this.hasNormals?this.normals[o.getNormalIndex()]:new Vec4(0,0,0,0);var u=s[o];null==u&&(u=t.getPositions().length,s.push({currentIndex:o,modelVertexIndex:u}),t.getPositions().push(c),t.getTexCoords().push(a),this.hasNormals&&t.getNormals().push(h));var l=i[o.getVertexIndex()];void 0===l&&(l=e.getPositions().length,i.push({currentIndex:o.getVertexIndex(),normalModelIndex:l}),e.getPositions().push(c),e.getTexCoords().push(a),e.getNormals().push(h),e.getTangents().push(new Vec4(0,0,0,0))),t.getIndices().push(u),e.getIndices().push(l),r.push({modelVertexIndex:u,normalModelIndex:l})}if(!this.hasNormals){e.calcNormals();for(n=0;n<t.getPositions().length;n++)t.getNormals().push(e.getNormals()[r[n]])}e.calcTangents();for(n=0;n<t.getPositions().length;n++)t.getTangents().push(e.getTangents()[r[n]]);return t}parseOBJIndex(t){var e=t.split("/"),s=new OBJIndex;return s.setVertexIndex(parseInt(e[0])-1),e.length>1&&(""!==e[1]&&(this.hasTexCoords=!0,s.setTexCoordIndex(parseInt(e[1])-1)),e.length>2&&(this.hasNormals=!0,s.setNormalIndex(parseInt(e[2])-1))),s}static removeEmptyStrings(t){for(var e=[],s=0;s<t.length;s++)""!==t[s]&&e.push(t[s]);return e}}class OBJIndex{constructor(){this.vertextIndex,this.texCoordIndex,this.normalIndex}equals(t){var e=t;return this.vertextIndex===e.vertextIndex&&this.texCoordIndex===e.texCoordIndex&&this.normalIndex===e.normalIndex}hashCode(){var t=17;return t=31*t+this.vertextIndex,t=31*t+this.texCoordIndex,t=31*t+this.normalIndex}getVertexIndex(){return this.vertextIndex}getTexCoordIndex(){return this.texCoordIndex}getNormalIndex(){return this.normalIndex}setVertexIndex(t){this.vertextIndex=t}setTexCoordIndex(t){this.texCoordIndex=t}setNormalIndex(t){this.normalIndex=t}}class IndexedModel{constructor(t=-1,e=""){this.positions=[],this.texCoords=[],this.normals=[],this.tangents=[],this.indices=[],this.id=t,this.name=e}calcNormals(){for(a=0;a<this.indices.length;a+=3){var t=this.indices[a],e=this.indices[a+1],s=this.indices[a+2],i=this.positions[e].subtractVec(this.positions[t]),r=this.positions[s].subtractVec(this.positions[t]),n=i.cross(r).normalized();this.normals.push(t,this.normals[t].addVec(n)),this.normals.push(e,this.normals[e].addVec(n)),this.normals.push(s,this.normals[s].addVec(n))}for(var a=0;a<this.normals.length;a++)this.normals.push(a,this.normals[a].normalized())}calcTangents(){for(var t=0;t<this.indices.length;t+=3){var e=this.indices[t],s=this.indices[t+1],i=this.indices[t+2];if(void 0!==this.positions[e]&&void 0!==this.positions[s]&&void 0!==this.positions[i]){var r=this.positions[s].subtractVec(this.positions[e]),n=this.positions[i].subtractVec(this.positions[e]),a=this.texCoords[s].getX()-this.texCoords[e].getX(),h=this.texCoords[s].getY()-this.texCoords[e].getY(),o=this.texCoords[i].getX()-this.texCoords[e].getX(),c=this.texCoords[i].getY()-this.texCoords[e].getY(),u=a*c-o*h,l=0==u?0:1/u,g=new Vec4(l*(c*r.getX()-h*n.getX()),l*(c*r.getY()-h*n.getY()),l*(c*r.getZ()-h*n.getZ()),0);this.tangents.push(e,this.tangents[e].addVec(g)),this.tangents.push(s,this.tangents[s].addVec(g)),this.tangents.push(i,this.tangents[i].addVec(g))}}}getPositions(){return this.positions}getTexCoords(){return this.texCoords}getNormals(){return this.normals}getTangents(){return this.tangents}getIndices(){return this.indices}getID(){return this.id}}class Mat4{constructor(){this.m=[[],[],[],[]],this.identity()}identity(){return this.m[0][0]=1,this.m[0][1]=0,this.m[0][2]=0,this.m[0][3]=0,this.m[1][0]=0,this.m[1][1]=1,this.m[1][2]=0,this.m[1][3]=0,this.m[2][0]=0,this.m[2][1]=0,this.m[2][2]=1,this.m[2][3]=0,this.m[3][0]=0,this.m[3][1]=0,this.m[3][2]=0,this.m[3][3]=1,this}screenSpaceTransform(t,e){return this.m[0][0]=t,this.m[0][1]=0,this.m[0][2]=0,this.m[0][3]=t-.5,this.m[1][0]=0,this.m[1][1]=-e,this.m[1][2]=0,this.m[1][3]=e-.5,this.m[2][0]=0,this.m[2][1]=0,this.m[2][2]=1,this.m[2][3]=0,this.m[3][0]=0,this.m[3][1]=0,this.m[3][2]=0,this.m[3][3]=1,this}perspective(t,e,s,i){var r=Math.tan(t/2),n=s-i;return this.m[0][0]=1/(r*e),this.m[0][1]=0,this.m[0][2]=0,this.m[0][3]=0,this.m[1][0]=0,this.m[1][1]=1/r,this.m[1][2]=0,this.m[1][3]=0,this.m[2][0]=0,this.m[2][1]=0,this.m[2][2]=(-s-i)/n,this.m[2][3]=2*i*s/n,this.m[3][0]=0,this.m[3][1]=0,this.m[3][2]=1,this.m[3][3]=0,this}multiply(t){for(var e=new Mat4,s=0;s<4;s++)for(var i=0;i<4;i++)e.set(s,i,this.m[s][0]*t.get(0,i)+this.m[s][1]*t.get(1,i)+this.m[s][2]*t.get(2,i)+this.m[s][3]*t.get(3,i));return e}translation(t,e,s){return this.m[0][0]=1,this.m[0][1]=0,this.m[0][2]=0,this.m[0][3]=t,this.m[1][0]=0,this.m[1][1]=1,this.m[1][2]=0,this.m[1][3]=e,this.m[2][0]=0,this.m[2][1]=0,this.m[2][2]=1,this.m[2][3]=s,this.m[3][0]=0,this.m[3][1]=0,this.m[3][2]=0,this.m[3][3]=1,this}rotation(t,e,s){var i=new Mat4,r=new Mat4,n=new Mat4;return n.m[0][0]=Math.cos(s),n.m[0][1]=-Math.sin(s),n.m[0][2]=0,n.m[0][3]=0,n.m[1][0]=Math.sin(s),n.m[1][1]=Math.cos(s),n.m[1][2]=0,n.m[1][3]=0,n.m[2][0]=0,n.m[2][1]=0,n.m[2][2]=1,n.m[2][3]=0,n.m[3][0]=0,n.m[3][1]=0,n.m[3][2]=0,n.m[3][3]=1,i.m[0][0]=1,i.m[0][1]=0,i.m[0][2]=0,i.m[0][3]=0,i.m[1][0]=0,i.m[1][1]=Math.cos(t),i.m[1][2]=-Math.sin(t),i.m[1][3]=0,i.m[2][0]=0,i.m[2][1]=Math.sin(t),i.m[2][2]=Math.cos(t),i.m[2][3]=0,i.m[3][0]=0,i.m[3][1]=0,i.m[3][2]=0,i.m[3][3]=1,r.m[0][0]=Math.cos(e),r.m[0][1]=0,r.m[0][2]=-Math.sin(e),r.m[0][3]=0,r.m[1][0]=0,r.m[1][1]=1,r.m[1][2]=0,r.m[1][3]=0,r.m[2][0]=Math.sin(e),r.m[2][1]=0,r.m[2][2]=Math.cos(e),r.m[2][3]=0,r.m[3][0]=0,r.m[3][1]=0,r.m[3][2]=0,r.m[3][3]=1,this.m=n.multiply(r.multiply(i)).getM(),this}rotationFU(t,e){var s=t.normalized(),i=e.normalized(),r=Vec4.crossVecs(i,s),n=Vec4.crossVecs(s,r);return this.rotationFUR(s,n,r)}rotationFUR(t,e,s){var i=t,r=s,n=e;return this.m[0][0]=r.getX(),this.m[0][1]=r.getY(),this.m[0][2]=r.getZ(),this.m[0][3]=0,this.m[1][0]=n.getX(),this.m[1][1]=n.getY(),this.m[1][2]=n.getZ(),this.m[1][3]=0,this.m[2][0]=i.getX(),this.m[2][1]=i.getY(),this.m[2][2]=i.getZ(),this.m[2][3]=0,this.m[3][0]=0,this.m[3][1]=0,this.m[3][2]=0,this.m[3][3]=1,this}scale(t,e,s){return this.m[0][0]=t,this.m[0][1]=0,this.m[0][2]=0,this.m[0][3]=0,this.m[1][0]=0,this.m[1][1]=e,this.m[1][2]=0,this.m[1][3]=0,this.m[2][0]=0,this.m[2][1]=0,this.m[2][2]=s,this.m[2][3]=0,this.m[3][0]=0,this.m[3][1]=0,this.m[3][2]=0,this.m[3][3]=1,this}transform(t){return new Vec4(this.m[0][0]*t.getX()+this.m[0][1]*t.getY()+this.m[0][2]*t.getZ()+this.m[0][3]*t.getW(),this.m[1][0]*t.getX()+this.m[1][1]*t.getY()+this.m[1][2]*t.getZ()+this.m[1][3]*t.getW(),this.m[2][0]*t.getX()+this.m[2][1]*t.getY()+this.m[2][2]*t.getZ()+this.m[2][3]*t.getW(),this.m[3][0]*t.getX()+this.m[3][1]*t.getY()+this.m[3][2]*t.getZ()+this.m[3][3]*t.getW())}static fromQuaternionTranslationScale(t,e,s){var i=t.x,r=t.y,n=t.z,a=t.w,h=i+i,o=r+r,c=n+n,u=i*h,l=i*o,g=i*c,p=r*o,m=r*c,d=n*c,w=a*h,y=a*o,v=a*c,x=s.x,f=s.y,T=s.z,V=[[],[],[]];return V[0][0]=(1-(p+d))*x,V[0][1]=(l+v)*x,V[0][2]=(g-y)*x,V[0][3]=0,V[1][0]=(l-v)*f,V[1][1]=(1-(u+d))*f,V[1][2]=(m+w)*f,V[1][3]=0,V[2][0]=(g+y)*T,V[2][1]=(m-w)*T,V[2][2]=(1-(u+p))*T,V[2][3]=0,V[3][0]=e.x,V[3][1]=e.y,V[3][2]=e.z,V[3][3]=1,V}get(t,e){return this.m[t][e]}getM(){for(var t=[[],[],[],[]],e=0;e<4;e++)for(var s=0;s<4;s++)t[e][s]=this.m[e][s];return t}set(t,e,s){this.m[t][e]=s}setM(t){this.m=t}}class Vec4{constructor(t,e,s,i){this.x=t,this.y=e,this.z=s,this.w=void 0===i?0:i}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}equals(t){return this.x===t.x&&this.y===t.y&&this.z===t.z}static greaterOrEqualThan(t,e){return t.x>=e.x&&t.y>=e.y&&t.z>=e.z}max(){return Math.max(Math.max(this.x,this.y),Math.max(this.z,this.w))}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z+this.w*t.w}cross(t){var e=this.y*t.z-this.z*t.y,s=this.z*t.x-this.x*t.z,i=this.x*t.y-this.y*t.x;return new Vec4(e,s,i,0)}clone(){return new Vec4(this.x,this.y,this.z,this.w)}static crossVecs(t,e){var s=t.y*e.z-t.z*e.y,i=t.z*e.x-t.x*e.z,r=t.x*e.y-t.y*e.x;return new Vec4(s,i,r,0)}lerp(t,e){return e>1?t:t.subtractVec(this).multiply(e).addVec(this)}normalized(){var t=this.length();return new Vec4(this.x/t,this.y/t,this.z/t,this.w/t)}rotate(t,e){var s=Math.sin(-e),i=Math.cos(-e);return this.cross(t.mul(s)).add(this.mul(i).add(t.mul(this.dot(t.mul(1-i)))))}rotateQuat(t){var e=t.conjugate(),s=t.multiplyVec(this).multiplyQuat(e);return new Vec4(s.getX(),s.getY(),s.getZ(),1)}add(t){return new Vec4(this.x+t,this.y+t,this.z+t,this.w+t)}addVec(t){return new Vec4(this.x+t.x,this.y+t.y,this.z+t.z,this.w+t.w)}subtract(t){return new Vec4(this.x-t,this.y-t,this.z-t,this.w-t)}subtractVec(t){return new Vec4(this.x-t.x,this.y-t.y,this.z-t.z,this.w-t.w)}subtractQuat(t){return new Vec4(this.x-t.x,this.y-t.y,this.z-t.z,this.w-t.w)}multiply(t){return new Vec4(this.x*t,this.y*t,this.z*t,this.w*t)}multiplyVec(t){return new Vec4(this.x*t.x,this.y*t.y,this.z*t.z,this.w*t.w)}divide(t){return new Vec4(this.x/t,this.y/t,this.z/t,this.w/t)}getX(){return this.x}getY(){return this.y}getZ(){return this.z}getW(){return this.w}static up(){return new Vec4(0,1,0)}static right(){return new Vec4(1,0,0)}static forward(){return new Vec4(0,0,1)}static all(){return new Vec4(1,1,1)}static addVecs(t,e){return new Vec4(t.x+e.x,t.y+e.y,t.z+e.z,t.w+e.w)}static subtractVecs(t,e){return new Vec4(t.x-e.x,t.y-e.y,t.z-e.z,t.w-e.w)}static multiplyVecByNum(t,e){return new Vec4(t.x*e,t.y*e,t.z*e,t.w*e)}static lerpVecs(t,e,s){return s>=1?e:Vec4.subtractVecs(e,t).multiply(s).addVec(t)}static nLerp(t,e,s){return s>=1?endP:Vec4.lerpVecs(t,e,s).normalized()}static distance(t,e){return Math.sqrt(Math.pow(t.x-e.x,2)+Math.pow(t.y-e.y,2)+Math.pow(t.z-e.z,2))}}class Vertex{constructor(t,e,s){this.pos=t,this.textCoords=e,this.textCoords=e||t,this.normal=s||t}clone(){return new Vertex(this.pos,this.textCoords,this.normal)}transform(t,e){return new Vertex(t.transform(this.pos),this.textCoords,e.transform(this.normal))}perspectiveDivide(){var t=new Vec4(this.pos.getX()/this.pos.getW(),this.pos.getY()/this.pos.getW(),this.pos.getZ()/this.pos.getW(),this.pos.getW());return new Vertex(t,this.textCoords,this.normal)}isInsideViewFrustum(){return Math.abs(this.pos.getX())<=Math.abs(this.pos.getW())&&Math.abs(this.pos.getY())<=Math.abs(this.pos.getW())&&Math.abs(this.pos.getZ())<=Math.abs(this.pos.getW())}triangleAreaTimesTwo(t,e){var s=t.get(0)-this.pos.getX(),i=t.get(1)-this.pos.getY(),r=e.get(0)-this.pos.getX();return s*(e.get(1)-this.pos.getY())-r*i}lerp(t,e){return new Vertex(this.pos.lerp(t.getPosition(),e),this.textCoords.lerp(t.getTexCoords(),e),this.normal.lerp(t.getNormal(),e))}get(t){switch(t){case 0:return this.pos.getX();case 1:return this.pos.getY();case 2:return this.pos.getZ();case 3:return this.pos.getW()}}set(t,e){switch(t){case 0:this.pos.x=e;break;case 1:this.pos.y=e;break;case 2:this.pos.z=e;break;case 3:this.pos.w=e}}getPosition(){return this.pos}setPosition(t){this.pos=t}getTexCoords(){return this.textCoords}getNormal(){return this.normal}}class Edge{constructor(t,e,s,i){this.yStart=parseInt(Math.ceil(e.get(1))),this.yEnd=parseInt(Math.ceil(s.get(1)));var r=s.get(1)-e.get(1),n=s.get(0)-e.get(0),a=this.yStart-e.get(1);this.xStep=n/r,this.x=e.get(0)+a*this.xStep;var h=this.x-e.get(0);this.texCoordX=t.getTexCoordX(i)+t.getTexCoordXXStep()*h+t.getTexCoordXYStep()*a,this.texCoordXStep=t.getTexCoordXYStep()+t.getTexCoordXXStep()*this.xStep,this.texCoordY=t.getTexCoordY(i)+t.getTexCoordYXStep()*h+t.getTexCoordYYStep()*a,this.texCoordYStep=t.getTexCoordYYStep()+t.getTexCoordYXStep()*this.xStep,this.oneOverZ=t.getOneOverZ(i)+t.getOneOverZXStep()*h+t.getOneOverZYStep()*a,this.oneOverZStep=t.getOneOverZYStep()+t.getOneOverZXStep()*this.xStep,this.depth=t.getDepth(i)+t.getDepthXStep()*h+t.getDepthYStep()*a,this.depthStep=t.getDepthYStep()+t.getDepthXStep()*this.xStep,this.lightAmt=t.getLightAmt(i)+t.getLightAmtXStep()*h+t.getLightAmtYStep()*a,this.lightAmtStep=t.getLightAmtYStep()+t.getLightAmtXStep()*this.xStep}step(){this.x+=this.xStep,this.texCoordX+=this.texCoordXStep,this.texCoordY+=this.texCoordYStep,this.oneOverZ+=this.oneOverZStep,this.depth+=this.depthStep,this.lightAmt+=this.lightAmtStep}getYStart(){return this.yStart}getYEnd(){return this.yEnd}getX(){return this.x}getTexCoordX(){return this.texCoordX}getTexCoordY(){return this.texCoordY}getOneOverZ(){return this.oneOverZ}getDepth(){return this.depth}getLightAmt(){return this.lightAmt}}class Transform{constructor(t,e,s){this.pos=t,this.rot=e,this.scale=s,void 0===this.pos&&(this.pos=new Vec4(0,0,0,0)),void 0===this.rot&&(this.rot=new Quaternion),void 0===this.scale&&(this.scale=new Vec4(1,1,1,1))}clone(){return new Transform(this.pos,this.rot,this.scale)}setPos(t){return new Transform(t,this.rot,this.scale)}rotate(t){return new Transform(this.pos,t.multiplyQuat(this.rot).normalized(),this.scale)}setScale(t){return new Transform(this.pos,this.rot,t)}lookAt(t,e){return this.rotate(this.getLookAtRotation(t,e))}getLookAtRotation(t,e){var s=new Mat4,i=t.subtractVec(this.pos).normalized();return new Quaternion({type:Quaternion.Type.INIT_MAT,mat:s.rotationFU(i,e)})}getTransformation(){var t=(new Mat4).translation(this.pos.getX(),this.pos.getY(),this.pos.getZ()),e=this.rot.toRotationMatrix(),s=(new Mat4).scale(this.scale.getX(),this.scale.getY(),this.scale.getZ());return t.multiply(e.multiply(s))}getTransformedPos(){return this.pos}getTransformedRot(){return this.rot}getPos(){return this.pos}getRot(){return this.rot}getScale(){return this.scale}}class Camera{constructor(t){this.transform=new Transform,this.projection=t}resetTarget(t){this.projection=(new Mat4).perspective(parseFloat(Utils.toRadians(70)),parseFloat(t.getWidth())/parseFloat(t.getHeight()),.1,1e3)}reset(){this.transform=new Transform}setPerspective(t){this.projection=(new Mat4).perspective(parseFloat(Utils.toRadians(t)),parseFloat(target.getWidth())/parseFloat(target.getHeight()),.1,1e3)}getViewProjection(){var t=this.getTransform().getTransformedRot().conjugate().toRotationMatrix(),e=this.getTransform().getTransformedPos().multiply(-1),s=(new Mat4).translation(e.getX(),e.getY(),e.getZ());return this.projection.multiply(t.multiply(s))}updateInput(t,e){var s=2.66*e,i=2*e,r=5*e;switch(t.getKey()){case Input.Key.W:this.move(this.getTransform().getRot().getForward(),r);break;case Input.Key.A:this.move(this.getTransform().getRot().getLeft(),r);break;case Input.Key.S:this.move(this.getTransform().getRot().getForward(),-r);break;case Input.Key.D:this.move(this.getTransform().getRot().getRight(),r);break;case Input.Key.RIGHT:this.rotate(Camera.Y_AXIS,s);break;case Input.Key.LEFT:this.rotate(Camera.Y_AXIS,-s);break;case Input.Key.DOWN:this.rotate(this.getTransform().getRot().getRight(),i);break;case Input.Key.UP:this.rotate(this.getTransform().getRot().getRight(),-i)}}moveTo(t,e){this.transform=this.getTransform().setPos(this.getTransform().getPos().lerp(t,e)),this.getTransform().getPos()>=t.z&&(this.getTransform().getPos().z=t.z)}move(t){this.transform=this.transform.setPos(t)}rotate(t,e){this.transform=this.getTransform().rotate(new Quaternion({type:Quaternion.Type.INIT_VEC_ANGLE,vec:t,angle:e}))}lookAt(t,e){this.transform=this.transform.lookAt(t,e)}getTransform(){return this.transform}}Camera.Y_AXIS=new Vec4(0,1,0);class PropsCamera extends Camera{constructor(t,e){super((new Mat4).perspective(parseFloat(Utils.toRadians(70)),parseFloat(t.getWidth())/parseFloat(t.getHeight()),.1,1e3)),this.tracks=e,this.currentFX=null,this.currentFXID=null,this.startTime=null,this.startPos=new Vec4(0,0,0),this.position=new Vec4(0,0,0),this.endPos=new Vec4(0,0,0),this.journeyLength=null,this.rot=null,this.trigger=!1,this.posY=0,this.posZ=0,this.setCurrentFX(Resources.FX.FX01)}update(t){this.reset(),this.currentFX(t)}reset(){super.reset(),this.rot=Quaternion.lookRotation(new Vec4(0,0,1e3),Camera.Y_AXIS)}FX01(t){var e=(Timeline.time()-this.startTime)/this.journeyLength*30;if(this.position=Vec4.lerpVecs(this.startPos,this.endPos,e),e>1){var s=Math.sin(.3*t)/1.2;this.position.x=s,this.position.z=2*s-3}this.move(this.position),this.lookAt(this.rot,Camera.Y_AXIS)}FX02(t){var e=Math.sin(.3*t)/2;this.position.z=2*e-3,this.move(this.position),this.rotate(new Vec4(0,0,1),Utils.toRadians(12)),this.lookAt(this.rot,Camera.Y_AXIS)}FX03(t){var e=(Timeline.time()-this.startTime)/this.journeyLength*30;this.position=Vec4.lerpVecs(this.startPos,this.endPos,e),this.move(this.position)}FX04(t){var e=(Timeline.time()-this.startTime)/this.journeyLength*30;this.position=Vec4.lerpVecs(this.startPos,this.endPos,e),this.move(this.position)}FX05(t){var e=(Timeline.time()-this.startTime)/this.journeyLength*100;this.move(Vec4.lerpVecs(this.startPos,this.endPos,e)),this.rotate(new Vec4(0,0,1),Utils.toRadians(-12))}FX06(t){var e=(Timeline.time()-this.startTime)/this.journeyLength*300;this.move(Vec4.lerpVecs(this.startPos,this.endPos,e))}FX07(t){var e=(Timeline.time()-this.startTime)/this.journeyLength*5,s=Vec4.lerpVecs(this.startPos,this.endPos,e);this.move(s)}FX08(t){var e,s=(Timeline.time()-this.startTime)/this.journeyLength,i=this.startPos.clone(),r=Math.sin(.3*t)/2;s>1?(e=1,i.x=r,i.z=2*r+i.z):(e=Vec4.lerpVecs(new Vec4(0,0,0),new Vec4(1,1,1),s).x,i.x=r*e,i.z=2*r*e+i.z),this.move(i),this.lookAt(this.rot,Camera.Y_AXIS)}FX09(t){var e=this.startPos.clone(),s=Math.sin(.3*t)/2;e.x=s,e.z=2*(s+e.z),this.move(e),this.lookAt(this.rot,Camera.Y_AXIS)}FX10(t){const e=this.tracks[14].getFrequency(20),s=this.tracks[14].getFrequency(30),i=Math.abs(e-s);let r=i>=.18;var n=(Timeline.time()-this.startTime)/this.journeyLength,a=Vec4.lerpVecs(this.startPos,this.endPos,n),h=new Vec4(0,0,a.z),o=new Vec4(0,0,0);let c;r?(c=-(a.z+5*i),this.posZ=c):c=this.posZ,this.trigger!==r&&(this.trigger=r,this.trigger&&(this.posY=Math.floor(-3*Math.random())+3)),h.x=o.x+c*Math.cos(Utils.toRadians(30*(t+135))),h.z=o.z+c*Math.sin(Utils.toRadians(30*(t+135))),h.y=this.posY,this.setPerspective(70-c),this.move(h),this.lookAt(o,Camera.Y_AXIS)}FX11(t){var e=(Timeline.time()-this.startTime)/this.journeyLength*100;this.move(Vec4.lerpVecs(this.startPos,this.endPos,e))}setCurrentFX(t){switch(t){case Resources.FX.FX01:this.startTime=Timeline.time(),this.startPos=new Vec4(0,0,-10),this.endPos=new Vec4(0,0,-2.5),this.journeyLength=Vec4.distance(this.startPos,this.endPos),this.currentFX=this.FX01;break;case Resources.FX.FX02:this.endPos=new Vec4(2,-.5,-4),this.currentFX=this.FX02;break;case Resources.FX.FX03:this.endPos=new Vec4(0,0,-4),this.currentFX=this.FX03;break;case Resources.FX.FX04:this.startPos=this.position,this.endPos=new Vec4(0,0,-4),this.currentFX=this.FX04;break;case Resources.FX.FX05:this.startTime=Timeline.time(),this.startPos=new Vec4(0,0,-4),this.endPos=new Vec4(0,0,-2),this.currentFX=this.FX05;break;case Resources.FX.FX06:this.startTime=Timeline.time(),this.startPos=new Vec4(0,0,-2),this.endPos=new Vec4(0,0,-4),this.currentFX=this.FX06;break;case Resources.FX.FX07:this.startTime=Timeline.time(),this.startPos=this.transform.getPos().clone(),this.endPos=new Vec4(0,0,-2),this.currentFX=this.FX07;break;case Resources.FX.FX08:this.startTime=Timeline.time(),this.startPos=this.transform.getPos().clone(),this.endPos=new Vec4(0,0,-2),this.journeyLength=1,this.currentFX=this.FX08;break;case Resources.FX.FX09:this.startPos=this.transform.getPos().clone(),this.currentFX=this.FX09;break;case Resources.FX.FX10:this.startTime=Timeline.time(),this.startPos=this.transform.getPos().clone(),this.endPos=new Vec4(0,0,-4),this.currentFX=this.FX10;break;case Resources.FX.FX11:this.startTime=Timeline.time(),this.setPerspective(70),this.startPos=new Vec4(0,0,-1.5),this.endPos=new Vec4(0,0,-100),this.journeyLength=Vec4.distance(this.startPos,this.endPos),this.currentFX=this.FX11}}}class PropsTyper{constructor(t,e){this.resources=t,this.canvas=e,this.context=this.canvas.getContext("2d"),this.intervalID=null,this.charCounter=-1,this.wait=!1,this.halt=!1,this.isDone=!1,this.props=t.getProps(),this.props2=t.getProps2(),this.propsHeader=[],this.currentFX=null,this.width=this.canvas.width,this.height=this.canvas.height,this.messagesArray=[],this.currentMessage=0,this.currentChar=0,this.charWidth=0,this.charHeight=0,this.offsetX=0,this.props2OffsetX=0,this.propsYPos,this.flashCounter=0,this.flashMax=6,this.isFlash=!1,this.showHeader=!1,this.blinkHeader=!1,this.flashMode=!1,this.setMessagesArray(t),this.currentBillboard=this.messagesArray[this.currentMessage];var s=this.currentBillboard[this.currentChar].width;this.alignProp(this.currentBillboard.length*s)}setMessagesArray(t){for(var e,s,i,r=0;r<this.props.length;r++){e=this.props[r].split(""),s=[];for(var n=0;n<e.length;n++)t.getChar(e[n])&&((i=t.getChar(e[n]).clone()).imageDataInverted=Utils.invertImage(t.getChar(e[n]).clone().imageData),s.push(i));this.messagesArray.push(s)}this.charWidth=i.width,this.propsYPos=this.height-i.height;for(var a=this.props2.split(""),r=0;r<a.length;r++)t.getChar(a[r])&&((i=t.getChar(a[r]).clone()).imageDataInverted=Utils.invertImage(t.getChar(a[r]).clone().imageData),this.propsHeader.push(i));this.props2OffsetX=this.width/2-this.propsHeader.length*i.width/2}resetCanvas(t){this.canvas=t,this.context=this.canvas.getContext("2d"),this.width=this.canvas.width,this.height=this.canvas.height;var e=this.currentBillboard[this.currentChar].width;this.alignProp(this.currentBillboard.length*e)}update(){if(!this.isDone)if(this.flashMode)this.flashPropsTyper();else{var t,e;if(this.showHeader)for(s=0;s<this.propsHeader.length;s++)e=s*(t=this.propsHeader[s]).width,this.blinkHeader?this.context.putImageData(t.imageDataInverted,e+this.props2OffsetX,0):this.context.putImageData(t.imageData,e+this.props2OffsetX,0);if(!this.halt)for(var s=0;s<this.currentBillboard.length&&!(-1===this.currentChar||s>this.currentChar);s++)e=s*(t=this.currentBillboard[s]).width+this.offsetX,this.isFlash?this.context.putImageData(t.imageDataInverted,e,this.propsYPos):this.context.putImageData(t.imageData,e,this.propsYPos)}}flashPropsTyper(){var t,e;if(this.showHeader)for(i=0;i<this.propsHeader.length;i++)e=i*(t=this.propsHeader[i]).width,this.blinkHeader?this.context.putImageData(t.imageDataInverted,e+this.props2OffsetX,0):this.context.putImageData(t.imageData,e+this.props2OffsetX,0);for(var s=this.messagesArray[this.messagesArray.length-1],i=0;i<s.length;i++)e=i*(t=s[i]).width+this.offsetX,this.isFlash?this.context.putImageData(t.imageDataInverted,e,this.propsYPos):this.context.putImageData(t.imageData,e,this.propsYPos)}end(){window.clearTimeout(this.intervalID),this.halt=!0,this.isDone=!0,this.context.clearRect(0,0,this.width,this.height)}alignProp(t){this.offsetX=this.width/2-t/2}updateProp(t){if(!this.flashMode&&!this.wait){this.wait=!0;var e=this;this.intervalID=window.setTimeout(function(){if(window.clearTimeout(e.intervalID),e.intervalID=null,e.currentChar++,e.currentChar>=e.currentBillboard.length)if(e.flashCounter===e.flashMax){if(e.isFlash=!1,e.flashCounter=0,e.currentChar=0,e.currentMessage++,e.currentMessage>=e.messagesArray.length)return e.flashMode=!0,void(e.currentMessage=0);5===e.currentMessage&&(e.halt=!0),e.currentBillboard=e.messagesArray[e.currentMessage],e.alignProp(e.currentBillboard.length*e.charWidth)}else e.flashCounter++,e.isFlash=!e.isFlash;e.wait=!1},100)}}updateHeader(t){this.blinkHeader=t,this.flashMode&&(this.isFlash=t)}setCurrentFX(t){switch(t){case Resources.FX.FX01:this.halt=!1;break;case Resources.FX.FX05:this.halt=!0;break;case Resources.FX.FX08:this.showHeader=!0,this.halt=!1,this.currentChar=-1;break;case Resources.FX.FX09:case Resources.FX.FX10:this.showHeader=!0;break;case Resources.FX.FX11:this.showHeader=!1,this.isDone=!0}}}class ParticlesSystem{constructor(t){this.numParticles=t.numParticles,this.particlesObj3D=[];for(var e=0;e<this.numParticles;e++)this.particlesObj3D.push({obj3d:new Object3D({mesh:resources.getMesh(2).clone(),texture:resources.getTexture(2),rad:1e3}),animData:{startPos:null,endPos:null,rotation:null,journeyLength:null}});this.startTime=null}update(t,e,s){if(this.isEmission)for(var i,r,n,a=Timeline.time()-this.startTime,h=0;h<this.numParticles;h++)r=a/(i=this.particlesObj3D[h]).animData.journeyLength*.5,n=Vec4.lerpVecs(i.animData.startPos,i.animData.endPos,r),i.obj3d.setPos(n.multiply(i.animData.speed)),i.obj3d.setRotate(new Quaternion({type:Quaternion.Type.INIT_VEC_ANGLE,vec:Vec4.all(),angle:i.animData.rot*s})),i.obj3d.setScale(i.animData.scale),i.obj3d.update(t,e,s)}reset(){for(var t=0;t<this.numParticles;t++)this.particlesObj3D[t].obj3d.reset()}setSimulation(t){for(var e,s,i,r,n,a=0;a<this.numParticles;a++){i=59*Math.random()-14,r=59*Math.random()-14,n=59*Math.random()-14;var h=Math.abs(n/45);e=this.particlesObj3D[a],s=Math.floor(Math.random()*(t.length-1-0+1))+0,e.animData.startPos=t[s],e.animData.endPos=new Vec4(i,r,n),e.animData.scale=new Vec4(h,h,h),e.animData.rot=r,e.animData.speed=45*Math.random()+2,e.animData.journeyLength=Vec4.distance(e.animData.startPos,e.animData.endPos)}}startEmission(){this.startTime=Timeline.time(),this.isEmission=!0}stopEmission(){this.isEmission=!1}}class Quaternion{constructor(t){if(!t)return this.x=0,this.y=0,this.z=0,void(this.w=1);switch(t.type){case Quaternion.Type.INIT_VALS:this.constructorWithVals(t.x,t.y,t.z,t.w);break;case Quaternion.Type.INIT_VEC_ANGLE:this.constructorWithVecAngle(t.vec,t.angle);break;case Quaternion.Type.INIT_MAT:this.constructorWithMat(t.mat);break;default:this.x=0,this.y=0,this.z=0,this.w=1}}constructorWithVals(t,e,s,i){this.x=t,this.y=e,this.z=s,this.w=i}constructorWithVecAngle(t,e){var s=parseFloat(Math.sin(e/2)),i=parseFloat(Math.cos(e/2));this.x=t.getX()*s,this.y=t.getY()*s,this.z=t.getZ()*s,this.w=i}constructorWithMat(t){var e=t.get(0,0)+t.get(1,1)+t.get(2,2);if(e>0){s=.5/parseFloat(Math.sqrt(e+1));this.w=.25/s,this.x=(t.get(1,2)-t.get(2,1))*s,this.y=(t.get(2,0)-t.get(0,2))*s,this.z=(t.get(0,1)-t.get(1,0))*s}else if(t.get(0,0)>t.get(1,1)&&t.get(0,0)>t.get(2,2)){s=2*parseFloat(Math.sqrt(1+t.get(0,0)-t.get(1,1)-t.get(2,2)));this.w=(t.get(1,2)-t.get(2,1))/s,this.x=.25*s,this.y=(t.get(1,0)+t.get(0,1))/s,this.z=(t.get(2,0)+t.get(0,2))/s}else if(t.get(1,1)>t.get(2,2)){s=2*parseFloat(Math.sqrt(1+t.get(1,1)-t.get(0,0)-t.get(2,2)));this.w=(t.get(2,0)-t.get(0,2))/s,this.x=(t.get(1,0)+t.get(0,1))/s,this.y=.25*s,this.z=(t.get(2,1)+t.get(1,2))/s}else{var s=2*parseFloat(Math.sqrt(1+t.get(2,2)-t.get(0,0)-t.get(1,1)));this.w=(t.get(0,1)-t.get(1,0))/s,this.x=(t.get(2,0)+t.get(0,2))/s,this.y=(t.get(1,2)+t.get(2,1))/s,this.z=.25*s}var i=parseFloat(Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w));this.x/=i,this.y/=i,this.z/=i,this.w/=i}length(){return parseFloat(Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w))}normalized(){var t=this.length();return this.x/=t,this.y/=t,this.z/=t,this.w/=t,this}conjugate(){return new Quaternion({type:Quaternion.Type.INIT_VALS,x:-this.x,y:-this.y,z:-this.z,w:this.w})}multiplyF(t){return new Quaternion({type:Quaternion.Type.INIT_VALS,x:this.x*t,y:this.y*t,z:this.z*t,w:this.w*t})}multiplyQuat(t){var e=this.w*t.getW()-this.x*t.getX()-this.y*t.getY()-this.z*t.getZ(),s=this.x*t.getW()+this.w*t.getX()+this.y*t.getZ()-this.z*t.getY(),i=this.y*t.getW()+this.w*t.getY()+this.z*t.getX()-this.x*t.getZ(),r=this.z*t.getW()+this.w*t.getZ()+this.x*t.getY()-this.y*t.getX();return new Quaternion({type:Quaternion.Type.INIT_VALS,x:s,y:i,z:r,w:e})}multiplyVec(t){var e=-this.x*t.getX()-this.y*t.getY()-this.z*t.getZ(),s=this.w*t.getX()+this.y*t.getZ()-this.z*t.getY(),i=this.w*t.getY()+this.z*t.getX()-this.x*t.getZ(),r=this.w*t.getZ()+this.x*t.getY()-this.y*t.getX();return new Quaternion({type:Quaternion.Type.INIT_VALS,x:s,y:i,z:r,w:e})}subQuat(t){return new Quaternion({type:Quaternion.Type.INIT_VALS,x:this.x-t.getX(),y:this.y-t.getY(),z:this.z-t.getZ(),w:this.w-t.getW()})}addQuat(t){return new Quaternion({type:Quaternion.Type.INIT_VALS,x:this.x+t.getX(),y:this.y+t.getY(),z:this.z+t.getZ(),w:this.w+t.getW()})}toRotationMatrix(){var t=new Vec4(2*(this.x*this.z-this.w*this.y),2*(this.y*this.z+this.w*this.x),1-2*(this.x*this.x+this.y*this.y)),e=new Vec4(2*(this.x*this.y+this.w*this.z),1-2*(this.x*this.x+this.z*this.z),2*(this.y*this.z-this.w*this.x)),s=new Vec4(1-2*(this.y*this.y+this.z*this.z),2*(this.x*this.y-this.w*this.z),2*(this.x*this.z+this.w*this.y));return(new Mat4).rotationFUR(t,e,s)}dot(t){return this.x*t.getX()+this.y*t.getY()+this.z*t.getZ()+this.w*t.getW()}NLerp(t,e,s){var i=t;return s&&this.dot(t)<0&&(i=new Quaternion({type:Quaternion.Type.INIT_VALS,x:-t.getX(),y:-t.getY(),z:-t.getZ(),w:-t.getW()})),i.subQuat(this).multiplyF(e).addQuat(this).normalized()}static lerp(t,e,s){var i=t.x,r=t.y,n=t.z,a=t.w,h=new Quaternion;return h.x=i+s*(e.x-i),h.y=r+s*(e.y-r),h.z=n+s*(e.z-n),h.w=a+s*(e.w-a),h}static sLerp(t,e,s,i=!1){var r=t.dot(e),n=e;if(i&&r<0&&(r=-r,n=new Quaternion({type:Quaternion.Type.INIT_VALS,x:-e.getX(),y:-e.getY(),z:-e.getZ(),w:-e.getW()})),Math.abs(r)>=-999)return Quaternion.nLerp(t,n,s,!1);var a=parseFloat(Math.sqrt(1-r*r)),h=parseFloat(Math.atan2(a,r)),o=1/a,c=parseFloat(Math.sin((1-s)*h))*o,u=parseFloat(Math.sin(s*h))*o;return t.multiplyF(c).addQuat(n.multiplyF(u))}static nLerp(t,e,s,i){var r=e;return i&&t.dot(e)<0&&(r=new Quaternion({type:Quaternion.Type.INIT_VALS,x:-e.getX(),y:-e.getY(),z:-e.getZ(),w:-e.getW()})),r.subQuat(t).multiplyF(s).addQuat(t).normalized()}SLerp(t,e,s=!1){var i=this.dot(t),r=t;if(s&&i<0&&(i=-i,r=new Quaternion({type:Quaternion.Type.INIT_VALS,x:-t.getX(),y:-t.getY(),z:-t.getZ(),w:-t.getW()})),Math.abs(i)>=-999)return this.NLerp(r,e,!1);var n=parseFloat(Math.sqrt(1-i*i)),a=parseFloat(Math.atan2(n,i)),h=1/n,o=parseFloat(Math.sin((1-e)*a))*h,c=parseFloat(Math.sin(e*a))*h;return this.multiplyF(o).addQuat(r.multiplyF(c))}getForward(){return new Vec4(0,0,1,1).rotateQuat(this)}getBack(){return new Vec4(0,0,-1,1).rotateQuat(this)}getUp(){return new Vec4(0,1,0,1).rotateQuat(this)}getDown(){return new Vec4(0,-1,0,1).rotateQuat(this)}getRight(){return new Vec4(1,0,0,1).rotateQuat(this)}getLeft(){return new Vec4(-1,0,0,1).rotateQuat(this)}getX(){return this.x}getY(){return this.y}getZ(){return this.z}getW(){return this.w}equals(t){return this.x===t.getX()&&this.y===t.getY()&&this.z===t.getZ()&&this.w===t.getW()}static lookRotation(t,e){var s=t,i=e,r=new Vec4,n=new Vec4;r=(r=(s=s.normalized()).cross(i)).normalized(),n=s.cross(r);var a,h,o,c,u,l=r.x,g=r.y,p=r.z,m=n.x,d=n.y,w=n.z,y=s.x,v=s.y,x=s.z,f=l+d+x;f>0?(c=.5*(u=Math.sqrt(f+1)),a=(w-v)*(u=.5/u),h=(y-p)*u,o=(g-m)*u):l>=d&&l>=x?(a=.5*(u=Math.sqrt(1+l-d-x)),h=(g+m)*(u=.5/u),o=(p+y)*u,c=(w-v)*u):d>x?(h=.5*(u=Math.sqrt(1+d-l-x)),a=(m+g)*(u=.5/u),o=(v+w)*u,c=(y-p)*u):(o=.5*(u=Math.sqrt(1+x-l-d)),a=(y+p)*(u=.5/u),h=(v+w)*u,c=(g-m)*u);var T=new Vec4;return T.x=a,T.y=h,T.z=o,T.w=c,T}}Quaternion.Type={INIT_VALS:0,INIT_VEC_ANGLE:1,INIT_MAT:2};class Gradients{constructor(t,e,s){var i=1/((e.getPosition().x-s.getPosition().x)*(t.getPosition().y-s.getPosition().y)-(t.getPosition().x-s.getPosition().x)*(e.getPosition().y-s.getPosition().y)),r=-i;this.texCoordX=[],this.texCoordY=[],this.oneOverZ=[],this.depth=[],this.lightAmt=[],this.depth[0]=t.getPosition().getZ(),this.depth[1]=e.getPosition().getZ(),this.depth[2]=s.getPosition().getZ(),this.oneOverZ[0]=1/t.getPosition().getW(),this.oneOverZ[1]=1/e.getPosition().getW(),this.oneOverZ[2]=1/s.getPosition().getW(),this.texCoordX[0]=t.getTexCoords().getX()*this.oneOverZ[0],this.texCoordX[1]=e.getTexCoords().getX()*this.oneOverZ[1],this.texCoordX[2]=s.getTexCoords().getX()*this.oneOverZ[2],this.texCoordY[0]=t.getTexCoords().getY()*this.oneOverZ[0],this.texCoordY[1]=e.getTexCoords().getY()*this.oneOverZ[1],this.texCoordY[2]=s.getTexCoords().getY()*this.oneOverZ[2],this.texCoordXXStep=this.calcXStep(this.texCoordX,t,e,s,i),this.texCoordXYStep=this.calcYStep(this.texCoordX,t,e,s,r),this.texCoordYXStep=this.calcXStep(this.texCoordY,t,e,s,i),this.texCoordYYStep=this.calcYStep(this.texCoordY,t,e,s,r),this.oneOverZXStep=this.calcXStep(this.oneOverZ,t,e,s,i),this.oneOverZYStep=this.calcYStep(this.oneOverZ,t,e,s,r),this.depthXStep=this.calcXStep(this.depth,t,e,s,i),this.depthYStep=this.calcYStep(this.depth,t,e,s,r);var n=new Vec4(0,.5,-1);this.lightAmt[0]=.9*this.saturate(t.getNormal().dot(n))+.2,this.lightAmt[1]=.9*this.saturate(e.getNormal().dot(n))+.2,this.lightAmt[2]=.9*this.saturate(s.getNormal().dot(n))+.2,this.lightAmtXStep=this.calcXStep(this.lightAmt,t,e,s,i),this.lightAmtYStep=this.calcYStep(this.lightAmt,t,e,s,r)}saturate(t){return t<0?0:t>1?1:t}calcXStep(t,e,s,i,r){return((t[1]-t[2])*(e.get(1)-i.get(1))-(t[0]-t[2])*(s.get(1)-i.get(1)))*r}calcYStep(t,e,s,i,r){return((t[1]-t[2])*(e.get(0)-i.get(0))-(t[0]-t[2])*(s.get(0)-i.get(0)))*r}getTexCoordX(t){return this.texCoordX[t]}getTexCoordY(t){return this.texCoordY[t]}getOneOverZ(t){return this.oneOverZ[t]}getDepth(t){return this.depth[t]}getLightAmt(t){return this.lightAmt[t]}getTexCoordXXStep(){return this.texCoordXXStep}getTexCoordXYStep(){return this.texCoordXYStep}getTexCoordYXStep(){return this.texCoordYXStep}getTexCoordYYStep(){return this.texCoordYYStep}getOneOverZXStep(){return this.oneOverZXStep}getOneOverZYStep(){return this.oneOverZYStep}getDepthXStep(){return this.depthXStep}getDepthYStep(){return this.depthYStep}getLightAmtXStep(){return this.lightAmtXStep}getLightAmtYStep(){return this.lightAmtYStep}}class Display{constructor(t){this.canvasContainer=t.view,this.reset(t)}swapBuffers(){this.displayImage.data.set(this.frameBuffer.components),this.graphics.putImageData(this.displayImage,0,0)}reset(t){this.canvasContainer.innerHTML="",this.frame=null,this.graphics=null,this.frameBuffer=null,this.frame=document.createElement("canvas"),this.frame.width=t.w,this.frame.height=t.h,this.frame.className=t.className,this.canvasContainer.appendChild(this.frame),this.graphics=this.frame.getContext("2d"),this.frameBuffer=new RenderContext(this.frame.width,this.frame.height),this.frameBuffer.clear(0),this.displayImage=new ImageData(this.frame.width,this.frame.height)}getCanvas(){return this.frame}}Display.Options={SHOW_HIDE_WIREFRAME:0},Display.Quality=[{w:240,h:180,className:"shit"},{w:480,h:320,className:"fair"},{w:800,h:600,className:"cool"}];class Texture{constructor(t){this.id=t.id,this.bmps=t.bmps,this.currentBmpIndex=0,this.bmp=this.bmps[this.currentBmpIndex],this.bmps.length>1?this.isAnim=!0:this.isAnim=!1,this.animID=null}setMainTexture(t){this.currentBmpIndex=t,this.bmp=this.bmps[this.currentBmpIndex]}play(){if(!this.animID&&1!==this.bmps.length){var t=this;this.animID=window.setInterval(function(){t.currentBmpIndex++,t.currentBmpIndex>=t.bmps.length&&(t.currentBmpIndex=0),t.bmp=t.bmps[t.currentBmpIndex]},50)}}stop(){this.animID&&1!==this.bmps.length&&(window.clearInterval(this.animID),this.animID=null)}setRadiance(t){this.bmp.setRadiance(t)}useLight(t){for(var e=0;e<this.bmps.length;e++)this.bmps[e].useLight=t}clone(){for(var t=[],e=0;e<this.bmps.length;e++)t.push(this.bmps[e].clone());return new Texture({id:this.id,bmps:t})}}class Bitmap{constructor(t){this.width=t.w,this.height=t.h,this.radiance=t.rad?this.radiance=t.rad:this.radiance=1,this.name=t.name,t.name?this.name=t.name:this.name="no_name",this.mode=t.mode,t.mode?this.mode=t.mode:this.mode=Bitmap.Modes.OPAQUE,this.useLight=!0,t.imgData?this.components=t.imgData:this.components=new Uint8ClampedArray(this.width*this.height*4),this.imageData=new ImageData(this.components,this.width,this.height),this.imageDataInverted=null}clone(){var t=new ImageData(this.width,this.height);return t.data.set(this.components),new Bitmap({w:this.width,h:this.height,imgData:t.data,rad:this.radiance,name:this.name,mode:this.mode})}clear(t){this.components.fill(t)}drawPixel(t,e,s,i,r,n){var a=4*(t+e*this.width);this.components[a]=s,this.components[a+1]=i,this.components[a+2]=r,this.components[a+3]=n}copyPixel(t,e,s,i,r,n){var a=4*parseInt(t+e*this.width),h=4*parseInt(s+i*r.getWidth()),o=new Color((255&r.getComponent(h))*n,(255&r.getComponent(h+1))*n,(255&r.getComponent(h+2))*n,r.getComponent(h+3));r.mode===Bitmap.Modes.TRANSPARENT&&this.components[a+3]>0&&(o=Color.blendAlpha(new Color(o.r,o.g,o.b),new Color(this.components[a],this.components[a+1],this.components[a+2]),r.getComponent(h+3)/255)),this.components[a]=o.r,this.components[a+1]=o.g,this.components[a+2]=o.b,this.components[a+3]=o.a}getWidth(){return this.width}getHeight(){return this.height}getComponent(t){return this.components[t]}getRadiance(){return this.radiance}setRadiance(t){this.radiance=t}}Bitmap.Modes={OPAQUE:0,TRANSPARENT:1};class Mesh{constructor(t){if(t){this.meshData=t,this.vertices=[],this.id=t.id,this.name=t.name;for(var e=0;e<t.getPositions().length;e++)this.vertices.push(new Vertex(t.getPositions()[e],t.getTexCoords()[e],t.getNormals()[e]));this.indices=t.getIndices()}}draw(t,e,s,i){for(var r=e.multiply(s),n=0;n<this.indices.length;n+=3)t.drawTriangle(this.vertices[this.indices[n]].transform(r,s),this.vertices[this.indices[n+1]].transform(r,s),this.vertices[this.indices[n+2]].transform(r,s),i.bmp)}getVertex(t){return this.vertices[t]}getIndex(t){return this.indices[t]}getNumIndices(){return this.indices.length}clone(){return new Mesh(this.meshData)}}class RenderContext extends Bitmap{constructor(t,e){super({w:t,h:e}),this.zBuffer=[],this.zBuffer.length=this.width*this.height,this.showEdges=!1,this.vertices=[]}clearDepthBuffer(){for(var t=0;t<this.zBuffer.length;t++)this.zBuffer[t]=Number.MAX_VALUE}drawLine(t,e,s,i,r=Color.white){var n=0,a=Math.abs(i-e),h=Math.abs(s-t),o=a<<1,c=h<<1,u=t<s?1:-1,l=e<i?1:-1;if(a<=h)for(g=0;g<h&&(this.drawPixel(parseInt(t),parseInt(e),r.r,r.g,r.b,r.a),t!=s);g++)t+=u,(n+=o)>h&&(e+=l,n-=c);else for(var g=0;g<h&&(this.drawPixel(parseInt(t),parseInt(e),r.r,r.g,r.b,r.a),e!=i);g++)e+=l,(n+=c)>a&&(t+=u,n-=o)}drawCurve(t,e=Color.white){for(var s,i,r,n=(new Mat4).screenSpaceTransform(this.width/2,this.height/2),a=0;a<t.length-1;a++)r=(new Mat4).identity(),s=t[a].transform(n,r).perspectiveDivide(),i=t[a+1].transform(n,r).perspectiveDivide(),this.drawLine(s.get(0),s.get(1),i.get(0),i.get(1))}drawTangents(t,e=Color.white){for(var s,i,r=(new Mat4).screenSpaceTransform(this.width/2,this.height/2),n=0;n<t.length;n++){var a=(new Mat4).identity();s=t[n].a.transform(r,a).perspectiveDivide(),i=t[n].b.transform(r,a).perspectiveDivide(),this.drawLine(s.get(0),s.get(1),i.get(0),i.get(1),e)}}render(){}drawTriangle(t,e,s,i){if(t.isInsideViewFrustum()&&e.isInsideViewFrustum()&&s.isInsideViewFrustum())this.fillTriangle(t,e,s,i);else if(this.vertices=[t,e,s],this.clipPolygonAxis(this.vertices,0)&&this.clipPolygonAxis(this.vertices,1)&&this.clipPolygonAxis(this.vertices,2))for(var r=this.vertices[0],n=1;n<this.vertices.length-1;n++)this.fillTriangle(r,this.vertices[n],this.vertices[n+1],i)}clipPolygonAxis(t,e){var s=[];return this.clipPolygonComponent(this.vertices,e,1,s),this.vertices=[],0!==s.length&&(this.clipPolygonComponent(s,e,-1,this.vertices),this.vertices.length>0)}clipPolygonComponent(t,e,s,i){for(var r=t[t.length-1],n=r.get(e)*s,a=n<=r.getPosition().getW(),h=this.makeIterator(t);h.hasNext();){var o=h.next().value,c=o.get(e)*s,u=c<=o.getPosition().getW();if(u^a){var l=(r.getPosition().getW()-n)/(r.getPosition().getW()-n-(o.getPosition().getW()-c));i.push(r.lerp(o,l))}u&&i.push(o),r=o,n=c,a=u}}fillTriangle(t,e,s,i){var r=(new Mat4).screenSpaceTransform(this.width/2,this.height/2),n=(new Mat4).identity(),a=t.transform(r,n).perspectiveDivide(),h=e.transform(r,n).perspectiveDivide(),o=s.transform(r,n).perspectiveDivide();if(!(a.triangleAreaTimesTwo(o,h)>=0)){if(o.get(1)<h.get(1)){c=o;o=h,h=c}if(h.get(1)<a.get(1)){c=h;h=a,a=c}if(o.get(1)<h.get(1)){var c=o;o=h,h=c}this.scanTriangle(a,h,o,a.triangleAreaTimesTwo(o,h)>=0,i)}}scanTriangle(t,e,s,i,r){var n=new Gradients(t,e,s),a=new Edge(n,t,s,0),h=new Edge(n,t,e,0),o=new Edge(n,e,s,1);this.scanEdges(n,a,h,i,r),this.scanEdges(n,a,o,i,r)}scanEdges(t,e,s,i,r){var n=e,a=s;if(i){var h=n;n=a,a=h}for(var o=s.getYStart(),c=s.getYEnd(),u=o;u<c;u++)this.drawScanLine(t,n,a,u,r),n.step(),a.step()}drawScanLine(t,e,s,i,r){for(var n=parseInt(Math.ceil(e.getX())),a=parseInt(Math.ceil(s.getX())),h=n-e.getX(),o=s.getX()-e.getX(),c=(s.getTexCoordX()-e.getTexCoordX())/o,u=(s.getTexCoordY()-e.getTexCoordY())/o,l=(s.getOneOverZ()-e.getOneOverZ())/o,g=(s.getDepth()-e.getDepth())/o,p=t.getLightAmtXStep(),m=e.getTexCoordX()+c*h,d=e.getTexCoordY()+u*h,w=e.getOneOverZ()+l*h,y=e.getDepth()+g*h,v=e.getLightAmt()+p*h,x=n;x<a;x++){var f=x+i*this.getWidth();if(y<this.zBuffer[f]){this.zBuffer[f]=y;var T=1/w,V=parseInt(m*T*(r.getWidth()-1)+.5),C=parseInt(d*T*(r.getHeight()-1)+.5);r.useLight?this.copyPixel(x,i,V,C,r,v*r.getRadiance()):this.copyPixel(x,i,V,C,r,1),this.showEdges&&(x!==n&&x+1!==a||this.drawPixel(x,i,255,0,0,255))}w+=l,m+=c,d+=u,y+=g,v+=p}}makeIterator(t){var e=0;return{next:function(){return e<t.length?{value:t[e++],done:!1}:{done:!0}},hasNext:function(){return e<t.length}}}}class Timeline{constructor(t){this.keyframes=t.keyframes,this.totalKeyframes=this.keyframes.length,this.callback=t.callback,this.creationTime=Timeline.time(),this.startTime=Timeline.time(),this.previsousTime=null,this.isRunning=!1,this.startedAt=0,this.pausedAt=0,this.currentKeyFrame=-1,this.currentTime,this.delta=0,this.tick=0}update(){this.currentTime=Timeline.time()-this.startedAt,this.previsousTime&&(this.delta=this.currentTime-this.previsousTime),this.previsousTime=this.currentTime,this.tick+=this.delta/1,this.getKeyframe()}play(){var t=Math.abs(this.pausedAt);this.startedAt=Timeline.time()-t,this.pausedAt=0,this.isRunning=!0}pause(){var t=Timeline.time()-this.startedAt;this.pausedAt=0,this.startedAt=0,this.pausedAt=t,this.isRunning=!1}getKeyframe(){var t,e=1e3*this.tick,s=(this.keyframes.length,0);for(s;s<this.totalKeyframes-1;s++)if(t=this.keyframes[s],s+1<this.totalKeyframes&&e>=t&&e<=this.keyframes[s+1]&&this.currentKeyFrame!==t)return this.currentKeyFrame=t,void this.callback(s)}gotoKeyframe(t){this.isRunning?this.startedAt=this.creationTime+this.keyframes[t]/1e3:this.pausedAt=this.creationTime+this.keyframes[t]/1e3,this.previsousTime=null,this.delta=0,this.tick=this.keyframes[t]/1e3}static time(){return Date.now()/1e3}}class UI_prod{constructor(t){this.callback=t;this.setLayout(UI_prod.Layouts.INIT)}onStart(){this.callback(States.START)}onPlay(){this.callback(States.PLAY)}onReplay(){this.onRestart()}onSettings(){this.setLayout(UI_prod.Layouts.SETTINGS)}onFullscreen(t){var e=!t.className.length>0;if(t.className.length>0?t.className="":t.className="active",e){var s=document.documentElement;(s.requestFullscreen||s.webkitRequestFullScreen||s.mozRequestFullScreen||s.msRequestFullscreen).call(s)}else document.webkitExitFullscreen()}onPause(){this.callback(States.PAUSE)}onRestart(){location.reload(!0)}onBack(){this.setLayout(UI_prod.Layouts.MAIN_MENU)}onVolumeChange(t){document.getElementById("volume-background").style.width=t+"%",document.getElementById("volume-button").getElementsByTagName("label")[0].innerHTML="GAIN: "+Math.round(t),this.callback(States.CHANGE_VOLUME,t)}onQualityChange(t){for(var e=document.getElementById("quality-buttons").children,s=0;s<e.length;s++)e[s].className.length>0&&(e[s].className="radio-button");e[t].className="radio-button-active",this.callback(States.CHANGE_QUALITY,Display.Quality[t])}getQuality(){for(var t=document.getElementById("quality-buttons").children,e=0;e<t.length;e++)if("radio-button-active"===t[e].className)return Display.Quality[e];return null}setLayout(t){switch(t){case UI_prod.Layouts.INIT:document.getElementById("menu").style.display="flex",document.getElementById("start").style.display="block",document.getElementById("overlay").style.display="flex",document.getElementById("play").style.display="none",document.getElementById("replay").style.display="none",document.getElementById("restart").style.display="none";break;case UI_prod.Layouts.START:document.getElementById("start").style.display="none",document.getElementById("play").style.display="block",document.getElementById("restart").style.display="block",document.getElementById("overlay").style.display="none",document.getElementById("menu").style.display="none",document.getElementById("loader").style.display="block";break;case UI_prod.Layouts.RUNNING:document.getElementById("menu").style.display="none",document.getElementById("loader").style.display="none",document.getElementById("overlay").style.display="none";var e=this,s=function(){e.onPause(),document.removeEventListener("click",s)};window.setTimeout(function(){document.addEventListener("click",s)},20);break;case UI_prod.Layouts.MAIN_MENU:document.getElementById("menu").style.display="flex",document.getElementById("overlay").style.display="flex";break;case UI_prod.Layouts.END:document.getElementById("menu").style.display="flex",document.getElementById("start").style.display="none",document.getElementById("overlay").style.display="flex",document.getElementById("play").style.display="none",document.getElementById("volume-button").style.display="none",document.getElementById("quality-buttons").style.display="none",document.getElementById("fullscreen").style.display="none",document.getElementById("replay").style.display="block",document.getElementById("restart").style.display="none"}}updateLoader(t,e){document.getElementById("loader").getElementsByTagName("h2")[0].innerHTML=t,document.getElementById("background").style.width=e+"%"}}UI_prod.Layouts={INIT:0,RUNNING:1,MAIN_MENU:2,LOADING:3,END:4};var LOCAL=!0,loader,display,target,animLoop=null,isRunning=!1,resources,timeline,ui,maquina,tunnel,camera,propsTyper,app=this,globalVolume=100;States={START:0,PLAY:1,PAUSE:2,CHANGE_VOLUME:3,CHANGE_QUALITY:4},window.onload=init;
    </script>
    
</body>
</html>